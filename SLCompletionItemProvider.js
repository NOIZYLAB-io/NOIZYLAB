"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_1=require("vscode"),functionsConfig=require("./data/functions.json"),keywordsConfig=require("./data/keywords.json"),Utilities_1=require("./Utilities"),functions=functionsConfig,keywords=keywordsConfig;class ShaderlabCompletionItemProvider{provideCompletionItems(t,e,i){let o=t.lineAt(e).text;var r=o.charAt(e.character-1);let n=[];return this.isInIncludeLine(t,e)?"/"!=r&&"\\"!=r||(n=this.getInclideCompletion(t,e)):n=this.getNormalCaseSet(t),Promise.resolve(n)}isInIncludeLine(t,e){return e=t.lineAt(e).text,/#include\s*?\"[\s\S]+?\"/.test(e)}getInclideCompletion(t,e){var e=t.lineAt(e).text,e=Utilities_1.default.getIncludeFiles(e)[0],o=Utilities_1.default.translatePackagePath(t.uri,e),e=Utilities_1.default.getFiles(o).filter(t=>!t.startsWith(".")&&!t.endsWith(".meta")),r=[];return e.forEach(t=>{console.log(t);var e=Utilities_1.default.join(o,t),i=Utilities_1.default.IsFolder(e),e=t;i&&(e=t.replace(/@[0-9a-zA-Z_\.-]+/,"")),r.push(this.getCompletionProposal(e,t,"",i?vscode_1.CompletionItemKind.Folder:vscode_1.CompletionItemKind.File))}),r}getNormalCaseSet(t){let e=[];for(var i in functions.Items){var o=functions.Items[i];e.push(this.getCompletionProposal(i,o.detail,o.documentation,functions.ItemKind))}for(var i in keywords.Items)for(var r in o=keywords.Items[i])(r=o[r])&&e.push(this.getCompletionProposal(r,"","",keywords.ItemKind));var n=t.getText();e=e.concat(this.getMethodInfo(n));let s=Utilities_1.default.getIncludeFilesContent(n,t.uri);s.forEach(t=>{e=e.concat(this.getMethodInfo(t))}),e=e.concat(this.getPropertiesInfo(n));var l=this.getStructuresInfo(n);e=e.concat(l),s.forEach(t=>{l=l.concat(this.getStructuresInfo(t)),e=e.concat(this.getStructuresInfo(t))});let a=[];return l.forEach(t=>{t&&a.push(t.label)}),e=e.concat(this.getVariablesInfo(n,a.join("|"))),e}getVariablesInfo(t,e){let i=[];var o,r,n,s=Utilities_1.default.getVariablesFromCode(t,e);for(o in s){let e=s[o];if(e){let t=e.substring(0,e.length-1).split(" ",2);2==t.length&&(r=t[0].trim(),n=t[1].trim(),i.push(this.getCompletionProposal(n,r,"",vscode_1.CompletionItemKind.Variable)))}}return i}getPropertiesInfo(t){return this.getCompletionItemFromMatchResult(t,Utilities_1.default.getPropertiesDefinationFromCode,t=>{let e=t.replace(/\(/gi,",").replace(/\)/gi,",").split(",");if(4<=e.length)return this.getCompletionProposal(e[0].trim(),e[2].trim(),"",vscode_1.CompletionItemKind.Property)})}getStructuresInfo(t){return this.getCompletionItemFromMatchResult(t,Utilities_1.default.getStructDefinationFromCode,t=>{let e=t.substring(6,t.length-7).split("{");if(2<=e.length)return this.getCompletionProposal(e[0].trim(),"struct","",vscode_1.CompletionItemKind.Struct)})}getMethodInfo(t){return this.getCompletionItemFromMatchResult(t,Utilities_1.default.getMethodCodeLineFromCode,t=>{var e=Utilities_1.default.getMethodNameFromSignatureCode(t);if(e)return this.getCompletionProposal(e,"",t.substring(0,t.length-1).trim(),vscode_1.CompletionItemKind.Method)})}getCompletionItemFromMatchResult(t,e,i){let o=[];var r,n=e(t);for(r in n){var s=n[r];s&&i(s)&&o.push(i(s))}return o}getCompletionProposal(t,e,i,o){let r=new vscode_1.CompletionItem(t,o);return r.detail=e,r.documentation=i,r}}ShaderlabCompletionItemProvider.triggerCharacters=["\\","/"],exports.default=ShaderlabCompletionItemProvider;