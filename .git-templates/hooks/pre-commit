#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════
# Pre-commit hook: Quality checks before committing
# ═══════════════════════════════════════════════════════════════════════════

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [[ -z "$STAGED_FILES" ]]; then
    exit 0
fi

# ─────────────────────────────────────────────────────────────────────────────
# Check for secrets/credentials
# ─────────────────────────────────────────────────────────────────────────────
echo -n "Checking for secrets... "
SECRETS_PATTERNS=(
    'password\s*='
    'api_key\s*='
    'apikey\s*='
    'secret\s*='
    'token\s*='
    'AWS_ACCESS_KEY_ID'
    'AWS_SECRET_ACCESS_KEY'
    'PRIVATE_KEY'
    'BEGIN RSA PRIVATE KEY'
    'BEGIN OPENSSH PRIVATE KEY'
)

for pattern in "${SECRETS_PATTERNS[@]}"; do
    if echo "$STAGED_FILES" | xargs grep -l -i -E "$pattern" 2>/dev/null | grep -v -E '\.(md|txt|example)$' > /dev/null; then
        echo -e "${RED}FAILED${NC}"
        echo -e "${RED}Potential secret found matching pattern: $pattern${NC}"
        echo "Check your staged files for credentials."
        exit 1
    fi
done
echo -e "${GREEN}OK${NC}"

# ─────────────────────────────────────────────────────────────────────────────
# Check for debug statements
# ─────────────────────────────────────────────────────────────────────────────
echo -n "Checking for debug statements... "
DEBUG_PATTERNS=(
    'console\.log'
    'debugger;'
    'print\s*\('
    'pdb\.set_trace'
    'breakpoint\(\)'
)

WARNINGS=""
for pattern in "${DEBUG_PATTERNS[@]}"; do
    MATCHES=$(echo "$STAGED_FILES" | xargs grep -l -E "$pattern" 2>/dev/null || true)
    if [[ -n "$MATCHES" ]]; then
        WARNINGS="${WARNINGS}Found $pattern in: $MATCHES\n"
    fi
done

if [[ -n "$WARNINGS" ]]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "${YELLOW}$WARNINGS${NC}"
    echo "Debug statements detected. Continue? (y/n)"
    read -r response < /dev/tty
    if [[ "$response" != "y" ]]; then
        exit 1
    fi
else
    echo -e "${GREEN}OK${NC}"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Check for large files
# ─────────────────────────────────────────────────────────────────────────────
echo -n "Checking file sizes... "
MAX_SIZE=5242880  # 5MB
LARGE_FILES=""

for file in $STAGED_FILES; do
    if [[ -f "$file" ]]; then
        size=$(wc -c < "$file")
        if [[ $size -gt $MAX_SIZE ]]; then
            LARGE_FILES="${LARGE_FILES}$file ($(numfmt --to=iec $size))\n"
        fi
    fi
done

if [[ -n "$LARGE_FILES" ]]; then
    echo -e "${YELLOW}WARNING${NC}"
    echo -e "${YELLOW}Large files detected:\n$LARGE_FILES${NC}"
    echo "Consider using Git LFS. Continue? (y/n)"
    read -r response < /dev/tty
    if [[ "$response" != "y" ]]; then
        exit 1
    fi
else
    echo -e "${GREEN}OK${NC}"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Run language-specific linters if available
# ─────────────────────────────────────────────────────────────────────────────

# Python files
PY_FILES=$(echo "$STAGED_FILES" | grep '\.py$' || true)
if [[ -n "$PY_FILES" ]] && command -v ruff &> /dev/null; then
    echo -n "Linting Python... "
    if echo "$PY_FILES" | xargs ruff check --quiet 2>/dev/null; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAILED${NC}"
        echo "Run 'ruff check --fix' to auto-fix issues"
        exit 1
    fi
fi

# TypeScript/JavaScript files
TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [[ -n "$TS_FILES" ]] && [[ -f "node_modules/.bin/eslint" ]]; then
    echo -n "Linting TypeScript/JavaScript... "
    if echo "$TS_FILES" | xargs ./node_modules/.bin/eslint --quiet 2>/dev/null; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${YELLOW}WARNING: ESLint issues found${NC}"
    fi
fi

echo -e "${GREEN}All checks passed!${NC}"
exit 0
