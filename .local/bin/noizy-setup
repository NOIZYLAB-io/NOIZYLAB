#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════
# noizy-setup - Complete system setup for a new machine
# Run this once on a fresh macOS install
# ═══════════════════════════════════════════════════════════════════════════

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

echo ""
echo -e "${CYAN}${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}${BOLD}"
echo '  _   _  ___  ___ _______   ___      _    ___    ___  ___ _____ _   _ ___'
echo ' | \ | |/ _ \|_ _|_  /\ \ / / |    / \  | __ ) / _ \| ____|_   _| | | |  _ \'
echo ' |  \| | | | || | / /  \ V /| |   / _ \ |  _ \| | | |  _|   | | | | | | |_) |'
echo ' | |\  | |_| || |/ /_   | | | |__/ ___ \| |_) | |_| | |___  | | | |_| |  __/'
echo ' |_| \_|\___/|___/____|  |_| |____/_/   \_\____/ \___/|_____| |_|  \___/|_|'
echo -e "${NC}"
echo -e "${CYAN}${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# ─────────────────────────────────────────────────────────────────────────────
# Check if running on macOS
# ─────────────────────────────────────────────────────────────────────────────
if [[ "$OSTYPE" != "darwin"* ]]; then
    echo -e "${RED}Error: This script is for macOS only${NC}"
    exit 1
fi

# ─────────────────────────────────────────────────────────────────────────────
# Install Homebrew if needed
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${CYAN}[1/6]${NC} Checking Homebrew..."
if ! command -v brew &> /dev/null; then
    echo -e "  Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
else
    echo -e "  ${GREEN}✓${NC} Homebrew installed"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Install packages from Brewfile
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${CYAN}[2/6]${NC} Installing packages..."
if [[ -f ~/Brewfile ]]; then
    brew bundle --file=~/Brewfile
    echo -e "  ${GREEN}✓${NC} Packages installed"
else
    echo -e "  ${YELLOW}⚠${NC} No Brewfile found at ~/Brewfile"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Set up shell
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${CYAN}[3/6]${NC} Configuring shell..."
if [[ -f ~/.zshrc ]]; then
    echo -e "  ${GREEN}✓${NC} .zshrc exists"
else
    echo -e "  ${YELLOW}⚠${NC} No .zshrc found"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Set up VS Code
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${CYAN}[4/6]${NC} Configuring VS Code..."
if command -v code-insiders &> /dev/null; then
    # Install recommended extensions
    EXTENSIONS=(
        "esbenp.prettier-vscode"
        "dbaeumer.vscode-eslint"
        "eamodio.gitlens"
        "ms-python.python"
        "charliermarsh.ruff"
        "usernamehw.errorlens"
        "gruntfuggly.todo-tree"
        "vscode-icons-team.vscode-icons"
        "foxundermoon.shell-format"
        "redhat.vscode-yaml"
        "tamasfe.even-better-toml"
    )

    for ext in "${EXTENSIONS[@]}"; do
        code-insiders --install-extension "$ext" --force 2>/dev/null || true
    done
    echo -e "  ${GREEN}✓${NC} Extensions installed"
else
    echo -e "  ${YELLOW}⚠${NC} VS Code Insiders not found"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Set up Git hooks
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${CYAN}[5/6]${NC} Configuring Git..."
if [[ -d ~/.git-templates/hooks ]]; then
    git config --global init.templateDir ~/.git-templates
    echo -e "  ${GREEN}✓${NC} Git hooks configured"
else
    echo -e "  ${YELLOW}⚠${NC} No git hooks template found"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Make scripts executable
# ─────────────────────────────────────────────────────────────────────────────
echo -e "${CYAN}[6/6]${NC} Finalizing..."
if [[ -d ~/.local/bin ]]; then
    chmod +x ~/.local/bin/* 2>/dev/null || true
    echo -e "  ${GREEN}✓${NC} Scripts are executable"
fi

# ─────────────────────────────────────────────────────────────────────────────
# Done!
# ─────────────────────────────────────────────────────────────────────────────
echo ""
echo -e "${CYAN}${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}${BOLD}✅ SETUP COMPLETE!${NC}"
echo ""
echo -e "Next steps:"
echo -e "  1. Run ${CYAN}source ~/.zshrc${NC} to reload shell"
echo -e "  2. Restart VS Code Insiders"
echo -e "  3. Run ${CYAN}vsc-hotrod${NC} in any project to add VS Code settings"
echo ""
echo -e "${CYAN}${BOLD}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
