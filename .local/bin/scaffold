#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════
# scaffold - NOIZYLAB Project Scaffolding Tool
# Create new projects with best practices built-in
# ═══════════════════════════════════════════════════════════════════════════

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# ─────────────────────────────────────────────────────────────────────────────
# Banner
# ─────────────────────────────────────────────────────────────────────────────
show_banner() {
    echo ""
    echo -e "${CYAN}${BOLD}"
    echo "  ╔═══════════════════════════════════════════════════════════════╗"
    echo "  ║   ___  ___   _   ___ ___ ___  _    ___                        ║"
    echo "  ║  / __|/ __| /_\ | __| __/ _ \| |  |   \                       ║"
    echo "  ║  \__ \ (__ / _ \| _|| _| (_) | |__| |) |                      ║"
    echo "  ║  |___/\___/_/ \_\_| |_| \___/|____|___/                       ║"
    echo "  ║                                                               ║"
    echo "  ║              NOIZYLAB Project Scaffolding                     ║"
    echo "  ╚═══════════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

# ─────────────────────────────────────────────────────────────────────────────
# Usage
# ─────────────────────────────────────────────────────────────────────────────
usage() {
    show_banner
    echo -e "${BOLD}Usage:${NC}"
    echo "  scaffold <type> <name> [options]"
    echo ""
    echo -e "${BOLD}Types:${NC}"
    echo -e "  ${CYAN}nextjs${NC}      Next.js 14+ with TypeScript, Tailwind, shadcn/ui"
    echo -e "  ${CYAN}python${NC}      Python with FastAPI, uv, pytest"
    echo -e "  ${CYAN}node${NC}        Node.js with TypeScript, ESLint, Vitest"
    echo -e "  ${CYAN}cli${NC}         CLI app with Typer (Python) or Commander (Node)"
    echo -e "  ${CYAN}api${NC}         REST API with OpenAPI docs"
    echo -e "  ${CYAN}monorepo${NC}    Turborepo monorepo setup"
    echo ""
    echo -e "${BOLD}Options:${NC}"
    echo "  --no-git      Don't initialize git repository"
    echo "  --no-vscode   Don't add VS Code settings"
    echo "  --dir <path>  Create in specific directory"
    echo ""
    echo -e "${BOLD}Examples:${NC}"
    echo "  scaffold nextjs my-app"
    echo "  scaffold python my-api --dir ~/projects"
    echo "  scaffold cli my-tool"
}

# ─────────────────────────────────────────────────────────────────────────────
# Create Next.js Project
# ─────────────────────────────────────────────────────────────────────────────
scaffold_nextjs() {
    local name="$1"
    echo -e "${CYAN}Creating Next.js project: ${BOLD}$name${NC}"

    pnpm create next-app "$name" \
        --typescript \
        --tailwind \
        --eslint \
        --app \
        --src-dir \
        --import-alias "@/*" \
        --use-pnpm

    cd "$name"

    # Add common dependencies
    echo -e "${CYAN}Adding dependencies...${NC}"
    pnpm add zod @tanstack/react-query
    pnpm add -D @types/node prettier prettier-plugin-tailwindcss

    # Create prettier config
    cat > .prettierrc << 'EOF'
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "all",
  "printWidth": 100,
  "plugins": ["prettier-plugin-tailwindcss"]
}
EOF

    # Create lib/utils.ts
    mkdir -p src/lib
    cat > src/lib/utils.ts << 'EOF'
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
EOF

    pnpm add clsx tailwind-merge

    echo -e "${GREEN}✓${NC} Next.js project created"
}

# ─────────────────────────────────────────────────────────────────────────────
# Create Python Project
# ─────────────────────────────────────────────────────────────────────────────
scaffold_python() {
    local name="$1"
    local pkg_name="${name//-/_}"
    echo -e "${CYAN}Creating Python project: ${BOLD}$name${NC}"

    mkdir -p "$name"
    cd "$name"

    # Initialize with uv
    uv init --name "$pkg_name"

    # Create project structure
    mkdir -p "src/$pkg_name" tests

    # Create package files
    cat > "src/$pkg_name/__init__.py" << EOF
"""$name - A Python package."""

__version__ = "0.1.0"
EOF

    cat > "src/$pkg_name/main.py" << 'EOF'
"""Main application module."""

from fastapi import FastAPI

app = FastAPI(
    title="API",
    description="API Description",
    version="0.1.0",
)


@app.get("/")
async def root():
    """Root endpoint."""
    return {"message": "Hello World"}


@app.get("/health")
async def health():
    """Health check endpoint."""
    return {"status": "healthy"}


if __name__ == "__main__":
    import uvicorn

    uvicorn.run(app, host="0.0.0.0", port=8000)
EOF

    # Create test file
    cat > tests/__init__.py << 'EOF'
EOF

    cat > tests/test_main.py << 'EOF'
"""Tests for main module."""

from fastapi.testclient import TestClient

from src.app.main import app

client = TestClient(app)


def test_root():
    """Test root endpoint."""
    response = client.get("/")
    assert response.status_code == 200
    assert response.json() == {"message": "Hello World"}


def test_health():
    """Test health endpoint."""
    response = client.get("/health")
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"
EOF

    # Add dependencies
    uv add fastapi uvicorn pydantic pydantic-settings
    uv add --dev pytest pytest-cov pytest-asyncio httpx ruff mypy

    # Create ruff config
    cat >> pyproject.toml << 'EOF'

[tool.ruff]
line-length = 100
target-version = "py312"

[tool.ruff.lint]
select = ["E", "F", "I", "N", "W", "UP", "B", "C4", "SIM"]

[tool.mypy]
python_version = "3.12"
strict = true

[tool.pytest.ini_options]
testpaths = ["tests"]
asyncio_mode = "auto"
EOF

    # Create Makefile
    cat > Makefile << 'EOF'
.PHONY: dev test lint format check

dev:
	uv run uvicorn src.app.main:app --reload

test:
	uv run pytest -v --cov

lint:
	uv run ruff check .
	uv run mypy src/

format:
	uv run ruff format .
	uv run ruff check --fix .

check: lint test
EOF

    echo -e "${GREEN}✓${NC} Python project created"
}

# ─────────────────────────────────────────────────────────────────────────────
# Create Node.js Project
# ─────────────────────────────────────────────────────────────────────────────
scaffold_node() {
    local name="$1"
    echo -e "${CYAN}Creating Node.js project: ${BOLD}$name${NC}"

    mkdir -p "$name"
    cd "$name"

    # Initialize with pnpm
    pnpm init

    # Update package.json
    cat > package.json << EOF
{
  "name": "$name",
  "version": "0.1.0",
  "type": "module",
  "main": "dist/index.js",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsup src/index.ts --format esm --dts",
    "start": "node dist/index.js",
    "test": "vitest run",
    "test:watch": "vitest",
    "lint": "eslint src/",
    "format": "prettier --write .",
    "check": "tsc --noEmit && pnpm lint"
  }
}
EOF

    # Add dependencies
    pnpm add zod
    pnpm add -D typescript tsx tsup @types/node
    pnpm add -D eslint @typescript-eslint/eslint-plugin @typescript-eslint/parser
    pnpm add -D prettier vitest

    # Create tsconfig
    cat > tsconfig.json << 'EOF'
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "outDir": "dist",
    "rootDir": "src",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
EOF

    # Create directories
    mkdir -p src tests

    # Create main file
    cat > src/index.ts << 'EOF'
console.log('Hello, World!');

export function greet(name: string): string {
  return `Hello, ${name}!`;
}
EOF

    # Create test file
    cat > tests/index.test.ts << 'EOF'
import { describe, it, expect } from 'vitest';
import { greet } from '../src/index';

describe('greet', () => {
  it('should greet by name', () => {
    expect(greet('World')).toBe('Hello, World!');
  });
});
EOF

    # Create ESLint config
    cat > eslint.config.js << 'EOF'
import eslint from '@eslint/js';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  eslint.configs.recommended,
  ...tseslint.configs.recommended,
  {
    ignores: ['dist/', 'node_modules/'],
  },
);
EOF

    # Create prettier config
    cat > .prettierrc << 'EOF'
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "all",
  "printWidth": 100
}
EOF

    echo -e "${GREEN}✓${NC} Node.js project created"
}

# ─────────────────────────────────────────────────────────────────────────────
# Create CLI Project
# ─────────────────────────────────────────────────────────────────────────────
scaffold_cli() {
    local name="$1"
    local pkg_name="${name//-/_}"
    echo -e "${CYAN}Creating CLI project: ${BOLD}$name${NC}"

    mkdir -p "$name"
    cd "$name"

    # Initialize with uv
    uv init --name "$pkg_name"

    # Create project structure
    mkdir -p "src/$pkg_name/commands" tests

    # Create main CLI file
    cat > "src/$pkg_name/__init__.py" << EOF
"""$name - Command line tool."""

__version__ = "0.1.0"
EOF

    cat > "src/$pkg_name/cli.py" << 'EOF'
"""Main CLI module."""

import typer
from rich.console import Console

app = typer.Typer(
    name="cli",
    help="CLI tool description",
    add_completion=True,
)
console = Console()


@app.command()
def hello(
    name: str = typer.Argument("World", help="Name to greet"),
    count: int = typer.Option(1, "--count", "-c", help="Number of greetings"),
):
    """Say hello."""
    for _ in range(count):
        console.print(f"[green]Hello, {name}![/green]")


@app.command()
def version():
    """Show version."""
    from . import __version__

    console.print(f"Version: {__version__}")


def main():
    """Entry point."""
    app()


if __name__ == "__main__":
    main()
EOF

    cat > "src/$pkg_name/__main__.py" << 'EOF'
"""Allow running with python -m."""

from .cli import main

main()
EOF

    # Add dependencies
    uv add typer rich
    uv add --dev pytest pytest-cov ruff mypy

    # Update pyproject.toml for CLI entry point
    cat >> pyproject.toml << EOF

[project.scripts]
$name = "$pkg_name.cli:main"

[tool.ruff]
line-length = 100

[tool.mypy]
python_version = "3.12"
strict = true
EOF

    echo -e "${GREEN}✓${NC} CLI project created"
    echo -e "Run with: ${CYAN}uv run $name --help${NC}"
}

# ─────────────────────────────────────────────────────────────────────────────
# Finalize Project
# ─────────────────────────────────────────────────────────────────────────────
finalize_project() {
    local name="$1"
    local init_git="${2:-true}"
    local add_vscode="${3:-true}"

    # Initialize git
    if [[ "$init_git" == "true" ]] && [[ ! -d .git ]]; then
        git init
        echo -e "${GREEN}✓${NC} Git initialized"
    fi

    # Add VS Code settings
    if [[ "$add_vscode" == "true" ]]; then
        ~/.local/bin/vsc-hotrod . 2>/dev/null || true
        echo -e "${GREEN}✓${NC} VS Code settings added"
    fi

    # Create CLAUDE.md
    if [[ ! -f CLAUDE.md ]]; then
        ~/.local/bin/claude-init "${PROJECT_TYPE:-python}" "$name" 2>/dev/null || true
    fi

    # Create .gitignore if missing
    if [[ ! -f .gitignore ]]; then
        cat > .gitignore << 'EOF'
# Dependencies
node_modules/
.venv/
venv/
__pycache__/
*.pyc

# Build
dist/
build/
*.egg-info/
.next/

# IDE
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Environment
.env
.env.local
.env*.local

# Logs
*.log
logs/

# Testing
coverage/
.coverage
htmlcov/
.pytest_cache/

# Misc
*.bak
*.tmp
EOF
        echo -e "${GREEN}✓${NC} .gitignore created"
    fi

    echo ""
    echo -e "${GREEN}${BOLD}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}${BOLD}✅ Project '$name' created successfully!${NC}"
    echo -e "${GREEN}${BOLD}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "Next steps:"
    echo -e "  ${CYAN}cd $name${NC}"
    echo -e "  ${CYAN}code-insiders .${NC}"
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────
main() {
    local type="${1:-}"
    local name="${2:-}"
    local init_git="true"
    local add_vscode="true"
    local target_dir="."

    # Parse options
    shift 2 2>/dev/null || true
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --no-git)
                init_git="false"
                ;;
            --no-vscode)
                add_vscode="false"
                ;;
            --dir)
                target_dir="$2"
                shift
                ;;
        esac
        shift
    done

    if [[ -z "$type" ]] || [[ -z "$name" ]]; then
        usage
        exit 1
    fi

    # Change to target directory
    mkdir -p "$target_dir"
    cd "$target_dir"

    # Export for template detection
    export PROJECT_TYPE="$type"

    # Create project based on type
    case "$type" in
        nextjs|next)
            scaffold_nextjs "$name"
            ;;
        python|py)
            scaffold_python "$name"
            ;;
        node|nodejs|ts)
            scaffold_node "$name"
            ;;
        cli)
            scaffold_cli "$name"
            ;;
        *)
            echo -e "${RED}Unknown project type: $type${NC}"
            usage
            exit 1
            ;;
    esac

    finalize_project "$name" "$init_git" "$add_vscode"
}

main "$@"
