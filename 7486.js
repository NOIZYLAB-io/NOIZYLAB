"use strict";exports.id=7486,exports.ids=[7486,5105],exports.modules={155105:(V,$,t)=>{t.d($,{fromSSO:()=>fe});var l=t(673230),F=t(631475),D=t(993628),O=t(657522),h=t(382308),E=t(410336);const y=e=>Object.entries(e).filter(([o])=>o.startsWith(h.I.SSO_SESSION+E.Q)).reduce((o,[s,n])=>({...o,[s.substring(s.indexOf(E.Q)+1)]:n}),{});var R=t(544898),X=t(356703);const Z=()=>({}),P=async(e={})=>(0,X.$H)(e.configFilepath??(0,O.g)()).then(R.A).then(y).catch(Z),b=e=>e&&(typeof e.sso_start_url=="string"||typeof e.sso_account_id=="string"||typeof e.sso_session=="string"||typeof e.sso_region=="string"||typeof e.sso_role_name=="string");var j=t(727650),q=t(470732);class p extends q.m{constructor(o,s=!0){super(o,s),this.name="TokenProviderError",Object.setPrototypeOf(this,p.prototype)}}var H=t(179896),_=t(776982),ee=t(16928),se=t(792747);const K=e=>{const s=(0,_.createHash)("sha1").update(e).digest("hex");return(0,ee.join)((0,se.R)(),".aws","sso","cache",`${s}.json`)},{readFile:oe}=H.promises,U={},G=async e=>{if(U[e])return U[e];const o=K(e),s=await oe(o,"utf8");return JSON.parse(s)},te=5*60*1e3,A="To refresh this SSO session run 'aws sso login' with the corresponding profile.",ne=async(e,o={})=>{const{SSOOIDCClient:s}=await t.e(7177).then(t.bind(t,837177));return new s(Object.assign({},o.clientConfig??{},{region:e??o.clientConfig?.region,logger:o.clientConfig?.logger??o.parentClientConfig?.logger}))},re=async(e,o,s={})=>{const{CreateTokenCommand:n}=await t.e(7177).then(t.bind(t,837177));return(await ne(o,s)).send(new n({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},M=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new p(`Token is expired. ${A}`,!1)},u=(e,o,s=!1)=>{if(typeof o>"u")throw new p(`Value not present for '${e}' in SSO Token${s?". Cannot refresh":""}. ${A}`,!1)},{writeFile:ie}=H.promises,ae=(e,o)=>{const s=K(e),n=JSON.stringify(o,null,2);return ie(s,n)},Y=new Date(0),ce=(e={})=>async({callerClientConfig:o}={})=>{const s={...e,parentClientConfig:{...o,...e.parentClientConfig}};s.logger?.debug("@aws-sdk/token-providers - fromSso");const n=await(0,D.Y)(s),r=(0,F.Bz)({profile:s.profile??o?.profile}),d=n[r];if(d){if(!d.sso_session)throw new p(`Profile '${r}' is missing required property 'sso_session'.`)}else throw new p(`Profile '${r}' could not be found in shared credentials file.`,!1);const g=d.sso_session,f=(await P(s))[g];if(!f)throw new p(`Sso session '${g}' could not be found in shared credentials file.`,!1);for(const a of["sso_start_url","sso_region"])if(!f[a])throw new p(`Sso session '${g}' is missing required property '${a}'.`,!1);const C=f.sso_start_url,i=f.sso_region;let c;try{c=await G(g)}catch{throw new p(`The SSO session token associated with profile=${r} was not found or is invalid. ${A}`,!1)}u("accessToken",c.accessToken),u("expiresAt",c.expiresAt);const{accessToken:v,expiresAt:I}=c,S={token:v,expiration:new Date(I)};if(S.expiration.getTime()-Date.now()>te)return S;if(Date.now()-Y.getTime()<30*1e3)return M(S),S;u("clientId",c.clientId,!0),u("clientSecret",c.clientSecret,!0),u("refreshToken",c.refreshToken,!0);try{Y.setTime(Date.now());const a=await re(c,i,s);u("accessToken",a.accessToken),u("expiresIn",a.expiresIn);const T=new Date(Date.now()+a.expiresIn*1e3);try{await ae(g,{...c,accessToken:a.accessToken,expiresAt:T.toISOString(),refreshToken:a.refreshToken})}catch{}return{token:a.accessToken,expiration:T}}catch{return M(S),S}},x=!1,z=async({ssoStartUrl:e,ssoSession:o,ssoAccountId:s,ssoRegion:n,ssoRoleName:r,ssoClient:d,clientConfig:g,parentClientConfig:k,profile:f,logger:C})=>{let i;const c="To refresh this SSO session run aws sso login with the corresponding profile.";if(o)try{const m=await ce({profile:f})();i={accessToken:m.token,expiresAt:new Date(m.expiration).toISOString()}}catch(m){throw new l.C(m.message,{tryNextLink:x,logger:C})}else try{i=await G(e)}catch{throw new l.C(`The SSO session associated with this profile is invalid. ${c}`,{tryNextLink:x,logger:C})}if(new Date(i.expiresAt).getTime()-Date.now()<=0)throw new l.C(`The SSO session associated with this profile has expired. ${c}`,{tryNextLink:x,logger:C});const{accessToken:v}=i,{SSOClient:I,GetRoleCredentialsCommand:S}=await t.e(9973).then(t.bind(t,769973)),a=d||new I(Object.assign({},g??{},{logger:g?.logger??k?.logger,region:g?.region??n}));let T;try{T=await a.send(new S({accountId:s,roleName:r,accessToken:v}))}catch(m){throw new l.C(m,{tryNextLink:x,logger:C})}const{roleCredentials:{accessKeyId:w,secretAccessKey:N,sessionToken:W,expiration:B,credentialScope:J,accountId:Q}={}}=T;if(!w||!N||!W||!B)throw new l.C("SSO returns an invalid temporary credential.",{tryNextLink:x,logger:C});const L={accessKeyId:w,secretAccessKey:N,sessionToken:W,expiration:new Date(B),...J&&{credentialScope:J},...Q&&{accountId:Q}};return o?(0,j.g)(L,"CREDENTIALS_SSO","s"):(0,j.g)(L,"CREDENTIALS_SSO_LEGACY","u"),L},le=(e,o)=>{const{sso_start_url:s,sso_account_id:n,sso_region:r,sso_role_name:d}=e;if(!s||!n||!r||!d)throw new l.C(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:o});return e},fe=(e={})=>async({callerClientConfig:o}={})=>{e.logger?.debug("@aws-sdk/credential-provider-sso - fromSSO");const{ssoStartUrl:s,ssoAccountId:n,ssoRegion:r,ssoRoleName:d,ssoSession:g}=e,{ssoClient:k}=e,f=(0,F.Bz)({profile:e.profile??o?.profile});if(!s&&!n&&!r&&!d&&!g){const i=(await(0,D.Y)(e))[f];if(!i)throw new l.C(`Profile ${f} was not found.`,{logger:e.logger});if(!b(i))throw new l.C(`Profile ${f} is not configured with SSO credentials.`,{logger:e.logger});if(i?.sso_session){const w=(await P(e))[i.sso_session],N=` configurations in profile ${f} and sso-session ${i.sso_session}`;if(r&&r!==w.sso_region)throw new l.C("Conflicting SSO region"+N,{tryNextLink:!1,logger:e.logger});if(s&&s!==w.sso_start_url)throw new l.C("Conflicting SSO start_url"+N,{tryNextLink:!1,logger:e.logger});i.sso_region=w.sso_region,i.sso_start_url=w.sso_start_url}const{sso_start_url:c,sso_account_id:v,sso_region:I,sso_role_name:S,sso_session:a}=le(i,e.logger);return z({ssoStartUrl:c,ssoSession:a,ssoAccountId:v,ssoRegion:I,ssoRoleName:S,ssoClient:k,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:f})}else{if(!s||!n||!r||!d)throw new l.C('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger});return z({ssoStartUrl:s,ssoSession:g,ssoAccountId:n,ssoRegion:r,ssoRoleName:d,ssoClient:k,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:f})}}},993628:(V,$,t)=>{t.d($,{Y:()=>D});var l=t(410336);const F=(...O)=>{const h={};for(const E of O)for(const[y,R]of Object.entries(E))h[y]!==void 0?Object.assign(h[y],R):h[y]=R;return h},D=async O=>{const h=await(0,l.p)(O);return F(h.configFile,h.credentialsFile)}}};
