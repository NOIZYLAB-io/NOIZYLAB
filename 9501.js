"use strict";var fe=Object.defineProperty;var ge=(O,c,s)=>c in O?fe(O,c,{enumerable:!0,configurable:!0,writable:!0,value:s}):O[c]=s;var Z=(O,c,s)=>(ge(O,typeof c!="symbol"?c+"":c,s),s);exports.id=9501,exports.ids=[9501],exports.modules={21882:(O,c,s)=>{s.d(c,{fromSSO:()=>ce});var r=s(966653),k=s(347874),T=s(336937),I=s(689465),A=s(504753),w=s(617391);const v=e=>Object.entries(e).filter(([t])=>t.startsWith(A.I.SSO_SESSION+w.Q)).reduce((t,[o,n])=>({...t,[o.substring(o.indexOf(w.Q)+1)]:n}),{});var R=s(908555),F=s(921710);const _=()=>({}),K=async(e={})=>(0,F.TA)(e.configFilepath??(0,I.g)()).then(R.A).then(v).catch(_),b=e=>e&&(typeof e.sso_start_url=="string"||typeof e.sso_account_id=="string"||typeof e.sso_session=="string"||typeof e.sso_region=="string"||typeof e.sso_role_name=="string");var U=s(313421),q=s(778273);class p extends q.m{constructor(o,n=!0){super(o,n);Z(this,"name","TokenProviderError");Object.setPrototypeOf(this,p.prototype)}}var W=s(910704);const ee=5*60*1e3,L="To refresh this SSO session run 'aws sso login' with the corresponding profile.",se=async(e,t={})=>{const{SSOOIDCClient:o}=await s.e(4188).then(s.bind(s,434188)),n=l=>t.clientConfig?.[l]??t.parentClientConfig?.[l];return new o(Object.assign({},t.clientConfig??{},{region:e??t.clientConfig?.region,logger:n("logger"),userAgentAppId:n("userAgentAppId")}))},oe=async(e,t,o={})=>{const{CreateTokenCommand:n}=await s.e(4188).then(s.bind(s,434188));return(await se(t,o)).send(new n({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},B=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new p(`Token is expired. ${L}`,!1)},m=(e,t,o=!1)=>{if(typeof t>"u")throw new p(`Value not present for '${e}' in SSO Token${o?". Cannot refresh":""}. ${L}`,!1)};var te=s(34659),ne=s(179896);const{writeFile:re}=ne.promises,ie=(e,t)=>{const o=(0,te.C)(e),n=JSON.stringify(t,null,2);return re(o,n)},j=new Date(0),ae=(e={})=>async({callerClientConfig:t}={})=>{const o={...e,parentClientConfig:{...t,...e.parentClientConfig}};o.logger?.debug("@aws-sdk/token-providers - fromSso");const n=await(0,T.Y)(o),i=(0,k.Bz)({profile:o.profile??t?.profile}),l=n[i];if(l){if(!l.sso_session)throw new p(`Profile '${i}' is missing required property 'sso_session'.`)}else throw new p(`Profile '${i}' could not be found in shared credentials file.`,!1);const f=l.sso_session,g=(await K(o))[f];if(!g)throw new p(`Sso session '${f}' could not be found in shared credentials file.`,!1);for(const a of["sso_start_url","sso_region"])if(!g[a])throw new p(`Sso session '${f}' is missing required property '${a}'.`,!1);const M=g.sso_start_url,S=g.sso_region;let d;try{d=await(0,W.v)(f)}catch{throw new p(`The SSO session token associated with profile=${i} was not found or is invalid. ${L}`,!1)}m("accessToken",d.accessToken),m("expiresAt",d.expiresAt);const{accessToken:C,expiresAt:u}=d,h={token:C,expiration:new Date(u)};if(h.expiration.getTime()-Date.now()>ee)return h;if(Date.now()-j.getTime()<30*1e3)return B(h),h;m("clientId",d.clientId,!0),m("clientSecret",d.clientSecret,!0),m("refreshToken",d.refreshToken,!0);try{j.setTime(Date.now());const a=await oe(d,S,o);m("accessToken",a.accessToken),m("expiresIn",a.expiresIn);const P=new Date(Date.now()+a.expiresIn*1e3);try{await ie(f,{...d,accessToken:a.accessToken,expiresAt:P.toISOString(),refreshToken:a.refreshToken})}catch{}return{token:a.accessToken,expiration:P}}catch{return B(h),h}},D=!1,H=async({ssoStartUrl:e,ssoSession:t,ssoAccountId:o,ssoRegion:n,ssoRoleName:i,ssoClient:l,clientConfig:f,parentClientConfig:x,profile:g,filepath:M,configFilepath:S,ignoreCache:d,logger:C})=>{let u;const h="To refresh this SSO session run aws sso login with the corresponding profile.";if(t)try{const y=await ae({profile:g,filepath:M,configFilepath:S,ignoreCache:d})();u={accessToken:y.token,expiresAt:new Date(y.expiration).toISOString()}}catch(y){throw new r.C(y.message,{tryNextLink:D,logger:C})}else try{u=await(0,W.v)(e)}catch{throw new r.C(`The SSO session associated with this profile is invalid. ${h}`,{tryNextLink:D,logger:C})}if(new Date(u.expiresAt).getTime()-Date.now()<=0)throw new r.C(`The SSO session associated with this profile has expired. ${h}`,{tryNextLink:D,logger:C});const{accessToken:a}=u,{SSOClient:P,GetRoleCredentialsCommand:E}=await s.e(9708).then(s.bind(s,779708)),N=l||new P(Object.assign({},f??{},{logger:f?.logger??x?.logger,region:f?.region??n,userAgentAppId:f?.userAgentAppId??x?.userAgentAppId}));let G;try{G=await N.send(new E({accountId:o,roleName:i,accessToken:a}))}catch(y){throw new r.C(y,{tryNextLink:D,logger:C})}const{roleCredentials:{accessKeyId:z,secretAccessKey:Y,sessionToken:J,expiration:Q,credentialScope:V,accountId:X}={}}=G;if(!z||!Y||!J||!Q)throw new r.C("SSO returns an invalid temporary credential.",{tryNextLink:D,logger:C});const $={accessKeyId:z,secretAccessKey:Y,sessionToken:J,expiration:new Date(Q),...V&&{credentialScope:V},...X&&{accountId:X}};return t?(0,U.g)($,"CREDENTIALS_SSO","s"):(0,U.g)($,"CREDENTIALS_SSO_LEGACY","u"),$},le=(e,t)=>{const{sso_start_url:o,sso_account_id:n,sso_region:i,sso_role_name:l}=e;if(!o||!n||!i||!l)throw new r.C(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:t});return e},ce=(e={})=>async({callerClientConfig:t}={})=>{e.logger?.debug("@aws-sdk/credential-provider-sso - fromSSO");const{ssoStartUrl:o,ssoAccountId:n,ssoRegion:i,ssoRoleName:l,ssoSession:f}=e,{ssoClient:x}=e,g=(0,k.Bz)({profile:e.profile??t?.profile});if(!o&&!n&&!i&&!l&&!f){const S=(await(0,T.Y)(e))[g];if(!S)throw new r.C(`Profile ${g} was not found.`,{logger:e.logger});if(!b(S))throw new r.C(`Profile ${g} is not configured with SSO credentials.`,{logger:e.logger});if(S?.sso_session){const E=(await K(e))[S.sso_session],N=` configurations in profile ${g} and sso-session ${S.sso_session}`;if(i&&i!==E.sso_region)throw new r.C("Conflicting SSO region"+N,{tryNextLink:!1,logger:e.logger});if(o&&o!==E.sso_start_url)throw new r.C("Conflicting SSO start_url"+N,{tryNextLink:!1,logger:e.logger});S.sso_region=E.sso_region,S.sso_start_url=E.sso_start_url}const{sso_start_url:d,sso_account_id:C,sso_region:u,sso_role_name:h,sso_session:a}=le(S,e.logger);return H({ssoStartUrl:d,ssoSession:a,ssoAccountId:C,ssoRegion:u,ssoRoleName:h,ssoClient:x,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:g,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}else{if(!o||!n||!i||!l)throw new r.C('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger});return H({ssoStartUrl:o,ssoSession:f,ssoAccountId:n,ssoRegion:i,ssoRoleName:l,ssoClient:x,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:g,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}}},34659:(O,c,s)=>{s.d(c,{C:()=>w});var r=s(776982),k=s.n(r),T=s(16928),I=s.n(T),A=s(572234);const w=v=>{const F=(0,r.createHash)("sha1").update(v).digest("hex");return(0,T.join)((0,A.R)(),".aws","sso","cache",`${F}.json`)}},910704:(O,c,s)=>{s.d(c,{a:()=>I,v:()=>A});var r=s(191943),k=s.n(r),T=s(34659);const I={},A=async w=>{if(I[w])return I[w];const v=(0,T.C)(w),R=await(0,r.readFile)(v,"utf8");return JSON.parse(R)}}};
