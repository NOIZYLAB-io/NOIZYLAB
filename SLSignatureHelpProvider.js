"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vscode_1=require("vscode"),functionsConfig=require("./data/functions.json"),Utilities_1=require("./Utilities"),functions=functionsConfig;class SLSignatureHelpProvider{provideSignatureHelp(e,t,r){var i=this.getFunctionName(e,t);if(!i)return Promise.resolve(null);let n=new vscode_1.SignatureHelp,a=this.getSignatureDataByFuncNameInConfig(i);a&&a.Synopsis.forEach(e=>{n.signatures.push(this.getSignatureInformationFromCode(e,a.documentation))});var o=e.getText();let s=this.getSignatureInCodeByName(o,i);if(s)n.signatures.push(s);else{var u,g=Utilities_1.default.getIncludeFilesContent(o,e.uri);for(u in g){var l=g[u];if(l&&(s=this.getSignatureInCodeByName(l,i),s)){n.signatures.push(s);break}}}return n.activeParameter=this.calcActiveParameter(e,t),n.activeSignature=this.calcActiveSignature(n),Promise.resolve(n)}calcActiveSignature(e){let t=0;for(const r of e.signatures){if(r.parameters.length>=e.activeParameter+1)return t;t++}}getSignatureInCodeByName(e,t){var r,i=this.getMethodInfoInCode(e);for(r in i){var n=i[r];if(n&&n.name===t)return this.getSignatureInformationFromCode(n.signature,n.signature)}}getMethodInfoInCode(e){let t=[];var r,i,n,a=Utilities_1.default.getMethodCodeLineFromCode(e);for(r in a){let e=a[r];e&&(i=Utilities_1.default.getMethodNameFromSignatureCode(e),n=e.substring(0,e.length-1).trim(),t.push({name:i,signature:n}))}return t}getSignatureInformationFromCode(e,t){let r=new vscode_1.SignatureInformation(e);return r.documentation=t,e=Utilities_1.default.getParameterInfosFromSignatureCode(e),r.parameters=e,r}getSignatureDataByFuncNameInConfig(e){return functions.Items[e]}getFunctionName(e,t){let r=e.lineAt(t.line),i=1,n;for(n=t.character-1;0<n&&0<i;n--){var a=r.text.charAt(n);")"===a&&i++,"("===a&&i--}return 0<i||n<=0?"":(t=new vscode_1.Position(t.line,n),e.getText(e.getWordRangeAtPosition(t)))}calcActiveParameter(e,t){let r=e.lineAt(t.line),i=0,n=0;for(let e=t.character-1;0<e;e--){var a=r.text.charAt(e);","===a&&0===n&&i++,"("===a&&n++,")"===a&&n--}return i}}SLSignatureHelpProvider.triggerChars=["(",","],exports.default=SLSignatureHelpProvider;