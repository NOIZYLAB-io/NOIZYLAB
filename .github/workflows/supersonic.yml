name: ğŸš€ NOIZYLAB CI/CD

on:
  push:
    branches: [main, xenodochial-almeida]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    name: ğŸ” Linting & Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install black ruff mypy -q
          pip install -r requirements.txt -q || true

      - name: Run Black Formatter
        run: |
          echo "ğŸ¨ Checking Python formatting..."
          black --check src/ QUICK_START_EXAMPLES.py || {
            echo "âŒ Code formatting issues found. Run 'black .' to fix."
            exit 1
          }

      - name: Run Ruff Linter
        run: |
          echo "ğŸ” Running Ruff linter..."
          ruff check src/ QUICK_START_EXAMPLES.py

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Lint TypeScript Worker
        working-directory: workers/noizylab
        run: |
          echo "ğŸ” Checking TypeScript worker..."
          npm install
          npm run build

  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt -q || true
          pip install pytest pytest-asyncio -q

      - name: Run Python Tests
        run: |
          echo "ğŸ§ª Running tests..."
          # Add test execution once tests exist
          echo "âš ï¸ No tests defined yet"

  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Bandit
        run: pip install bandit[toml] safety

      - name: Run Bandit Security Scan
        run: |
          echo "ğŸ”’ Running security scan..."
          bandit -r src/ -ll || true

      - name: Check Dependencies for Vulnerabilities
        run: |
          echo "ğŸ” Checking for vulnerable dependencies..."
          pip install -r requirements.txt -q
          safety check --json || true

  supersonic:
    name: ğŸ” System Checks
    runs-on: ubuntu-latest
    needs: [lint, test]
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Worker Health
        run: |
          echo "ğŸŒ Checking Cloudflare Worker..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://noizylab.rsplowman.workers.dev || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Worker: HTTP $HTTP_CODE"
          else
            echo "âš ï¸ Worker: HTTP $HTTP_CODE (may need deploy)"
          fi

      - name: Validate Shell Scripts
        run: |
          echo "ğŸ“œ Checking shell scripts..."
          for script in autorun.sh supersonic.sh ultimate.sh scripts/*.sh; do
            if [ -f "$script" ]; then
              bash -n "$script" && echo "âœ… $script: Valid" || echo "âŒ $script: Syntax error"
            fi
          done

      - name: Check Project Structure
        run: |
          echo "ğŸ“ Validating project structure..."
          [ -d "src/core" ] && echo "âœ… src/core exists" || echo "âŒ src/core missing"
          [ -d "src/integrations" ] && echo "âœ… src/integrations exists" || echo "âŒ src/integrations missing"
          [ -f "ARCHITECTURE.md" ] && echo "âœ… ARCHITECTURE.md exists" || echo "âŒ ARCHITECTURE.md missing"
          [ -f ".env.example" ] && echo "âœ… .env.example exists" || echo "âŒ .env.example missing"

  deploy:
    name: ğŸš€ Deploy Worker
    runs-on: ubuntu-latest
    needs: [lint, test, supersonic, security]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/xenodochial-almeida'
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare
        working-directory: workers/noizylab
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            npm install
            wrangler deploy
            echo "âœ… Deployed successfully"
          else
            echo "âš ï¸ CLOUDFLARE_API_TOKEN not set, skipping deploy"
          fi

  notify:
    name: ğŸ“£ Summary
    runs-on: ubuntu-latest
    needs: [lint, test, security, supersonic, deploy]
    if: always()
    permissions: {}
    steps:
      - name: Build Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸŒ NOIZYLAB â€” The United Nations of Code                   â•‘"
          echo "â•‘   https://github.com/NOIZYLAB-io/NOIZYLAB                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Checks: ${{ needs.supersonic.result }}"
          echo "Deploy: ${{ needs.deploy.result }}"
          echo ""
          echo "GoRunFree! ğŸš€"
