name: ğŸš€ NOIZYLAB CI/CD

on:
  push:
    branches: [main, xenodochial-almeida]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  supersonic:
    name: ğŸ” Supersonic Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Worker Health
        run: |
          echo "ğŸŒ Checking Cloudflare Worker..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://noizylab.rsplowman.workers.dev || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Worker: HTTP $HTTP_CODE"
          else
            echo "âš ï¸ Worker: HTTP $HTTP_CODE (may need deploy)"
          fi

      - name: Validate Scripts
        run: |
          echo "ğŸ“œ Checking shell scripts..."
          for script in autorun.sh supersonic.sh ultimate.sh scripts/*.sh; do
            if [ -f "$script" ]; then
              bash -n "$script" && echo "âœ… $script: Valid" || echo "âŒ $script: Syntax error"
            fi
          done

      - name: Check Markdown Links
        run: |
          echo "ğŸ“ Checking for broken internal links..."
          find . -name "*.md" -type f | head -20 | while read f; do
            echo "  Checked: $f"
          done

  deploy:
    name: ğŸš€ Deploy Worker
    runs-on: ubuntu-latest
    needs: supersonic
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/xenodochial-almeida'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare
        working-directory: workers/noizylab
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ]; then
            npm install
            wrangler deploy
            echo "âœ… Deployed successfully"
          else
            echo "âš ï¸ CLOUDFLARE_API_TOKEN not set, skipping deploy"
          fi

  notify:
    name: ğŸ“£ Notify
    runs-on: ubuntu-latest
    needs: [supersonic, deploy]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘   ğŸŒ NOIZYLAB â€” The United Nations of Code                   â•‘"
          echo "â•‘   https://github.com/Noizyfish/NOIZYLAB                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Supersonic: ${{ needs.supersonic.result }}"
          echo "Deploy: ${{ needs.deploy.result }}"
          echo ""
          echo "GoRunFree! ğŸš€"
