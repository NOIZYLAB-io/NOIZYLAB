name: Tailscale Infrastructure CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'scripts/**'
      - 'config/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.github/workflows/tailscale-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'config/**'
      - 'Dockerfile'
      - 'docker-compose.yml'

jobs:
  validate-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Validate bash scripts
        run: |
          find scripts -name "*.sh" -type f -exec shellcheck {} \;

      - name: Check script permissions
        run: |
          if find scripts -name "*.sh" -type f ! -perm -u=x | grep -q .; then
            echo "Error: Some shell scripts are not executable"
            find scripts -name "*.sh" -type f ! -perm -u=x
            exit 1
          fi
          echo "All shell scripts are executable"

  validate-json:
    name: Validate JSON Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate ACL template
        run: |
          python3 -m json.tool config/tailscale-acl-template.json > /dev/null
          echo "ACL template JSON is valid"

  test-docker-build:
    name: Test Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: noizylab-tailscale:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run --rm noizylab-tailscale:test tailscale version

  test-installation:
    name: Test Installation Script
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run syntax check
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            bash -n scripts/setup-tailscale-linux.sh
            bash -n scripts/configure-tailscale.sh
            bash -n scripts/healthcheck-tailscale.sh
          elif [ "$RUNNER_OS" == "macOS" ]; then
            bash -n scripts/setup-tailscale-macos.sh
            bash -n scripts/configure-tailscale.sh
            bash -n scripts/healthcheck-tailscale.sh
          fi

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [validate-scripts, validate-json, test-docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/noizylab-tailscale:latest
            ghcr.io/${{ github.repository_owner }}/noizylab-tailscale:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [test-docker-build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
