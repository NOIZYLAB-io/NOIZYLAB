"use strict";var te=Object.create;var b=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var ie=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var oe=(n,e)=>{for(var t in e)b(n,t,{get:e[t],enumerable:!0})},j=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ne(e))!se.call(n,i)&&i!==t&&b(n,i,{get:()=>e[i],enumerable:!(r=re(e,i))||r.enumerable});return n};var ae=(n,e,t)=>(t=n!=null?te(ie(n)):{},j(e||!n||!n.__esModule?b(t,"default",{value:n,enumerable:!0}):t,n)),ce=n=>j(b({},"__esModule",{value:!0}),n);var Be={};oe(Be,{initVitest:()=>$e});module.exports=ce(Be);var J=require("console"),K=require("crypto"),q=require("os"),Y=require("path"),O=require("stream");function C(n){return n!=null}function M(n){return n===null||typeof n!="function"&&typeof n!="object"}var le=/^[A-Za-z]:\//;function ue(n=""){return n&&n.replace(/\\/g,"/").replace(le,e=>e.toUpperCase())}var fe=/^[/\\](?![/\\])|^[/\\]{2}(?!\.)|^[A-Za-z]:[/\\]/;function pe(){return typeof process<"u"&&typeof process.cwd=="function"?process.cwd().replace(/\\/g,"/"):"/"}var P=function(...n){n=n.map(r=>ue(r));let e="",t=!1;for(let r=n.length-1;r>=-1&&!t;r--){let i=r>=0?n[r]:pe();!i||i.length===0||(e=`${i}/${e}`,t=L(i))}return e=de(e,!t),t&&!L(e)?`/${e}`:e.length>0?e:"."};function de(n,e){let t="",r=0,i=-1,s=0,o=null;for(let a=0;a<=n.length;++a){if(a<n.length)o=n[a];else{if(o==="/")break;o="/"}if(o==="/"){if(!(i===a-1||s===1))if(s===2){if(t.length<2||r!==2||t[t.length-1]!=="."||t[t.length-2]!=="."){if(t.length>2){let c=t.lastIndexOf("/");c===-1?(t="",r=0):(t=t.slice(0,c),r=t.length-1-t.lastIndexOf("/")),i=a,s=0;continue}else if(t.length>0){t="",r=0,i=a,s=0;continue}}e&&(t+=t.length>0?"/..":"..",r=2)}else t.length>0?t+=`/${n.slice(i+1,a)}`:t=n.slice(i+1,a),r=a-i-1;i=a,s=0}else o==="."&&s!==-1?++s:s=-1}return t}var L=function(n){return fe.test(n)};var me=44,A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ge=new Uint8Array(64),B=new Uint8Array(128);for(let n=0;n<A.length;n++){let e=A.charCodeAt(n);ge[n]=e,B[e]=n}function h(n,e){let t=0,r=0,i=0;do{let o=n.next();i=B[o],t|=(i&31)<<r,r+=5}while(i&32);let s=t&1;return t>>>=1,s&&(t=-2147483648|-t),e+t}function U(n,e){return n.pos>=e?!1:n.peek()!==me}var ve=class{constructor(n){this.pos=0,this.buffer=n}next(){return this.buffer.charCodeAt(this.pos++)}peek(){return this.buffer.charCodeAt(this.pos)}indexOf(n){let{buffer:e,pos:t}=this,r=e.indexOf(n,t);return r===-1?e.length:r}};function he(n){let{length:e}=n,t=new ve(n),r=[],i=0,s=0,o=0,a=0,c=0;do{let f=t.indexOf(";"),u=[],d=!0,m=0;for(i=0;t.pos<f;){let l;i=h(t,i),i<m&&(d=!1),m=i,U(t,f)?(s=h(t,s),o=h(t,o),a=h(t,a),U(t,f)?(c=h(t,c),l=[i,s,o,a,c]):l=[i,s,o,a]):l=[i],u.push(l),t.pos++}d||be(u),r.push(u),t.pos=f+1}while(t.pos<=e);return r}function be(n){n.sort(Te)}function Te(n,e){return n[0]-e[0]}var w=0,Ee=1,we=2,ye=3,Se=4,E=!1;function xe(n,e,t,r){for(;t<=r;){let i=t+(r-t>>1),s=n[i][w]-e;if(s===0)return E=!0,i;s<0?t=i+1:r=i-1}return E=!1,t-1}function ke(n,e,t){for(let r=t+1;r<n.length&&n[r][w]===e;t=r++);return t}function Re(n,e,t){for(let r=t-1;r>=0&&n[r][w]===e;t=r--);return t}function Ce(n,e,t,r){let{lastKey:i,lastNeedle:s,lastIndex:o}=t,a=0,c=n.length-1;if(r===i){if(e===s)return E=o!==-1&&n[o][w]===e,o;e>=s?a=o===-1?0:o:c=o}return t.lastKey=r,t.lastNeedle=e,t.lastIndex=xe(n,e,a,c)}var Pe="`line` must be greater than 0 (lines start at line 1)",_e="`column` must be greater than or equal to 0 (columns start at column 0)",V=-1,We=1;function Ie(n){var e;return(e=n)._decoded||(e._decoded=he(n._encoded))}function Fe(n,e){let{line:t,column:r,bias:i}=e;if(t--,t<0)throw new Error(Pe);if(r<0)throw new Error(_e);let s=Ie(n);if(t>=s.length)return T(null,null,null,null);let o=s[t],a=Oe(o,n._decodedMemo,t,r,i||We);if(a===-1)return T(null,null,null,null);let c=o[a];if(c.length===1)return T(null,null,null,null);let{names:f,resolvedSources:u}=n;return T(u[c[Ee]],c[we]+1,c[ye],c.length===5?f[c[Se]]:null)}function T(n,e,t,r){return{source:n,line:e,column:t,name:r}}function Oe(n,e,t,r,i){let s=Ce(n,r,e,t);return E?s=(i===V?ke:Re)(n,r,s):i===V&&s++,s===-1||s===n.length?-1:s}var G=/^\s*at .*(?:\S:\d+|\(native\))/m,Ne=/^(?:eval@)?(?:\[native code\])?$/,De=["node:internal",/\/packages\/\w+\/dist\//,/\/@vitest\/\w+\/dist\//,"/vitest/dist/","/vitest/src/","/node_modules/chai/","/node_modules/tinyspy/","/vite/dist/node/module-runner","/rolldown-vite/dist/node/module-runner","/deps/chunk-","/deps/@vitest","/deps/loupe","/deps/chai","/browser-playwright/dist/locators.js","/browser-webdriverio/dist/locators.js","/browser-preview/dist/locators.js",/node:\w+/,/__vitest_test__/,/__vitest_browser__/,/\/deps\/vitest_/];function z(n){if(!n.includes(":"))return[n];let t=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(n.replace(/^\(|\)$/g,""));if(!t)return[n];let r=t[1];if(r.startsWith("async ")&&(r=r.slice(6)),r.startsWith("http:")||r.startsWith("https:")){let i=new URL(r);i.searchParams.delete("import"),i.searchParams.delete("browserv"),r=i.pathname+i.hash+i.search}if(r.startsWith("/@fs/")){let i=/^\/@fs\/[a-zA-Z]:\//.test(r);r=r.slice(i?5:4)}return[r,t[2]||void 0,t[3]||void 0]}function je(n){let e=n.trim();if(Ne.test(e)||(e.includes(" > eval")&&(e=e.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),!e.includes("@")))return null;let t=-1,r="",i;for(let c=0;c<e.length;c++)if(e[c]==="@"){let f=e.slice(c+1);if(f.includes(":")&&f.length>=3){t=c,r=f,i=c>0?e.slice(0,c):void 0;break}}if(t===-1||!r.includes(":")||r.length<3)return null;let[s,o,a]=z(r);return!s||!o||!a?null:{file:s,method:i||"",line:Number.parseInt(o),column:Number.parseInt(a)}}function Me(n){let e=n.trim();if(!G.test(e))return null;e.includes("(eval ")&&(e=e.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));let t=e.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),r=t.match(/ (\(.+\)$)/);t=r?t.replace(r[0],""):t;let[i,s,o]=z(r?r[1]:t),a=r&&t||"",c=i&&["eval","<anonymous>"].includes(i)?void 0:i;return!c||!s||!o?null:(a.startsWith("async ")&&(a=a.slice(6)),c.startsWith("file://")&&(c=c.slice(7)),c=c.startsWith("node:")||c.startsWith("internal:")?c:P(c),a&&(a=a.replace(/__vite_ssr_import_\d+__\./g,"").replace(/(Object\.)?__vite_ssr_export_default__\s?/g,"")),{method:a,file:c,line:Number.parseInt(s),column:Number.parseInt(o)})}function _(n,e={}){let{ignoreStackEntries:t=De}=e;return(G.test(n)?Ae(n):Le(n)).map(i=>{var s;e.getUrlId&&(i.file=e.getUrlId(i.file));let o=(s=e.getSourceMap)===null||s===void 0?void 0:s.call(e,i.file);if(!o||typeof o!="object"||!o.version)return $(t,i.file)?null:i;let a=new W(o,i.file),c=Ve(a,i);if(!c)return i;let{line:f,column:u,source:d,name:m}=c,l=d||i.file;return l.match(/\/\w:\//)&&(l=l.slice(1)),$(t,l)?null:f!=null&&u!=null?{line:f,column:u,file:l,method:m||i.method}:i}).filter(i=>i!=null)}function $(n,e){return n.some(t=>e.match(t))}function Le(n){return n.split(`
`).map(e=>je(e)).filter(C)}function Ae(n){return n.split(`
`).map(e=>Me(e)).filter(C)}function Q(n,e={}){if(!n||M(n))return[];if("stacks"in n&&n.stacks)return n.stacks;let t=n.stack||"",r=typeof t=="string"?_(t,e):[];if(!r.length){let i=n;i.fileName!=null&&i.lineNumber!=null&&i.columnNumber!=null&&(r=_(`${i.fileName}:${i.lineNumber}:${i.columnNumber}`,e)),i.sourceURL!=null&&i.line!=null&&i._column!=null&&(r=_(`${i.sourceURL}:${i.line}:${i.column}`,e))}return e.frameFilter&&(r=r.filter(i=>e.frameFilter(n,i)!==!1)),n.stacks=r,r}var W=class{_encoded;_decoded;_decodedMemo;url;version;names=[];resolvedSources;constructor(e,t){this.map=e;let{mappings:r,names:i,sources:s}=e;this.version=e.version,this.names=i||[],this._encoded=r||"",this._decodedMemo=Ue(),this.url=t,this.resolvedSources=(s||[]).map(o=>P(o||"",t))}};function Ue(){return{lastKey:-1,lastNeedle:-1,lastIndex:-1}}function Ve(n,e){let t=Fe(n,e);return t.column==null?null:t}var Z=ae(require("events"),1);var X=require("fs"),I=process.env.VITEST_VSCODE_LOG==="verbose"?(...n)=>{console.info(...n)}:void 0,y=class{constructor(e){this.vitest=e}_enabled=!1;async enableCoverage(){await this.vitest.enableCoverage(),this._enabled=!0}disableCoverage(){this._enabled=!1,this.vitest.disableCoverage()}async waitForReport(){if(!this._enabled)return null;let e=this.vitest,t=e.config.coverage;return I?.(`Waiting for the coverage report to generate: ${t.reportsDirectory}`),await e.waitForTestRunEnd(),(0,X.existsSync)(t.reportsDirectory)?(I?.(`Coverage reports retrieved: ${t.reportsDirectory}`),t.reportsDirectory):(I?.(`Coverage reports directory not found: ${t.reportsDirectory}`),null)}};var S=class{constructor(e,t=!1,r){this.vitest=e;this.debug=t;this.emitter=r}rpc;async getFiles(){return this.vitest.clearSpecificationsCache(),(await this.vitest.globTestSpecifications()).map(t=>{let r=t.project.config;return[t.moduleId,{project:t.project.name,pool:r.pool,browser:r.browser?.enabled?{provider:r.browser.provider?.name||"preview",name:r.browser.name}:void 0}]})}async collectTests(e){let t=await this.resolveTestSpecifications(e);await this.collectSpecifications(t)}async collectSpecifications(e){let r=(await this.vitest.experimental_parseSpecifications(e)).map(i=>this.rpc.onCollected(i.task,!0));await Promise.all(r)}initRpc(e){this.rpc=e}cancelRun(){return this.vitest.cancelCurrentRun("keyboard-input")}async runTests(e,t){let r=this.getGlobalTestNamePattern();if(t&&this.vitest.setGlobalTestNamePattern(t),!e||this.isOnlyDirectories(e)){let i=await this.vitest.getRelevantTestSpecifications(e);await this.vitest.rerunTestSpecifications(i,!0)}else{let i=await this.resolveTestSpecifications(e);await this.vitest.rerunTestSpecifications(i,!1)}this.debug&&(await this.vitest.close(),this.emitter.close()),r?this.vitest.setGlobalTestNamePattern(r):this.vitest.resetGlobalTestNamePattern()}getGlobalTestNamePattern(){return this.vitest.configOverride.testNamePattern!=null?this.vitest.configOverride.testNamePattern:this.vitest.config.testNamePattern}async resolveTestSpecifications(e){let t=[];return e.forEach(r=>{let[i,s]=r,o=this.vitest.getProjectByName(i);t.push(o.createSpecification(s))}),t}async updateSnapshots(e,t){let r=this.getGlobalTestNamePattern();this.vitest.enableSnapshotUpdate();try{return await this.runTests(e,t)}finally{r?this.vitest.setGlobalTestNamePattern(r):this.vitest.resetSnapshotUpdate()}}isOnlyDirectories(e){return typeof e[0]=="string"}};function F(n){let e=new Set,t=null,r=null;return i=>{e.add(i),r&&clearTimeout(r),r=setTimeout(()=>{if(t)return;let s=Array.from(e);e.clear(),t=n(s).finally(()=>{t=null})},50)}}var x=class{constructor(e,t){this.runner=t;e.onFilterWatchedSpecification(r=>this.shouldRunSpecification(r)?!0:(this.scheduleAstCollection(r),!1))}enabled=!1;trackingEveryFile=!1;trackedTestItems={};trackedDirectories=[];scheduleAstCollection=F(async e=>{await this.runner.collectSpecifications(e)});shouldRunSpecification(e){if(!this.enabled)return!1;if(this.trackingEveryFile||this.isTestFileWatched(e.moduleId,this.trackedDirectories))return!0;let t=e.project.name,r=this.trackedTestItems[t];return r?.length?r.includes(e.moduleId):!1}trackTestItems(e){if(this.enabled=!0,typeof e[0]=="string")this.trackedDirectories=e;else for(let[t,r]of e)this.trackedTestItems[t]||(this.trackedTestItems[t]=[]),this.trackedTestItems[t].push(r)}trackEveryFile(){this.enabled=!0,this.trackingEveryFile=!0}stopTracking(){this.enabled=!1,this.trackingEveryFile=!1,this.trackedTestItems={},this.trackedDirectories=[]}isTestFileWatched(e,t){return t?.length?t.some(r=>r===e?!0:r[r.length-1]==="/"?e.startsWith(r):!1):!1}};var v=class n{constructor(e,t=!1,r){this.vitest=e;this.runner=new S(e,t,r),this.watcher=new x(e,this.runner),this.coverage=new y(e)}watcher;coverage;runner;static emitter=new Z.default;async getFiles(){return this.runner.getFiles()}async collectTests(e){return this.runner.collectTests(e)}cancelRun(){return this.runner.cancelRun()}async runTests(e,t){await this.runner.runTests(e,t)}async updateSnapshots(e,t){return this.runner.updateSnapshots(e,t)}watchTests(e,t){t&&this.vitest.setGlobalTestNamePattern(t),e?this.watcher.trackTestItems(e):this.watcher.trackEveryFile()}unwatchTests(){this.watcher.stopTracking()}async invalidateIstanbulTestModules(){}async enableCoverage(){await this.coverage.enableCoverage()}disableCoverage(){this.coverage.disableCoverage()}waitForCoverageReport(){return this.coverage.waitForReport()}onFilesChanged(e){e.forEach(t=>this.vitest.watcher.onFileChange(t))}onFilesCreated(e){e.forEach(t=>this.vitest.watcher.onFileCreate(t))}dispose(){return this.coverage.disableCoverage(),this.watcher.stopTracking(),this.vitest.close()}close(){return this.dispose()}initRpc(e){this.runner.initRpc(e)}getModuleEnvironments(e){return this.vitest.projects.map(t=>{let r=new Map;for(let i in t.vite.environments){let o=[...t.vite.environments[i].moduleGraph.getModulesByFile(e)||[]];o.some(a=>a.transformResult)&&r.set(i,{timestamp:o[0].lastInvalidationTimestamp})}return{name:t.name,environments:Array.from(r).map(([i,{timestamp:s}])=>({name:i,transformTimestamp:s}))}})}getTransformedModule(e,t,r){let i=this.vitest.projects.find(a=>a.name===e),o=(t==="__browser__"?i?.browser?.vite?.environments.client:i?.vite.environments[t])?.moduleGraph.getModulesByFile(r);return!o||!o.size?null:o.values().next().value?.transformResult?.code??null}async getSourceModuleDiagnostic(e){return this.vitest.experimental_getSourceModuleDiagnostic?await this.vitest.experimental_getSourceModuleDiagnostic(e):{modules:[],untrackedModules:[]}}onBrowserDebug(e){n.emitter.emit("onBrowserDebug",e)}};var k=class{rpc;vitest;setupFilePaths;constructor(e){this.setupFilePaths=e.setupFilePaths}onInit(e){this.vitest=e,e.projects.forEach(t=>{this.ensureSetupFileIsAllowed(t.vite.config)})}initRpc(e){this.rpc=e}onBrowserInit(e){let t=e.browser.vite.config;this.ensureSetupFileIsAllowed(t);let r=()=>new Promise((i,s)=>{v.emitter.on("onBrowserDebug",o=>{o?i():s(new Error("Browser Debugger failed to connect."))})});e.browser.parent.commands.__vscode_waitForDebugger=r}onUserConsoleLog(e){let t=e;if(e.origin)try{let r=e.taskId?this.vitest.state.idMap.get(e.taskId):null,i=r?this.vitest.state.getReportedEntity(r).project:this.vitest.getRootProject(),s=e.browser?i.browser?.parseErrorStacktrace({stack:e.origin}):Q({stack:e.origin});if(s&&s.length>0){let o=s[0];o.file&&o.line!=null&&o.column!=null&&(t.parsedLocation={file:o.file,line:o.line-1,column:o.column})}}catch{}this.rpc.onConsoleLog(t)}onTaskUpdate(e){this.rpc.onTaskUpdate(e.map(t=>{let r=this.vitest.state.idMap.get(t[0]);return t[1]||!r?[t[0],t[1],{}]:r.mode==="todo"||r.mode==="skip"?[t[0],{state:r.mode},{}]:[t[0],t[1],{}]}))}onTestRunStart(e){let t=e.map(r=>r.moduleId);this.rpc.onTestRunStart(Array.from(new Set(t)),!1),this.vitest.state.filesMap.clear()}onTestRunEnd(e,t){let r=e.map(i=>H(i));t.length&&this.vitest.logger.printUnhandledErrors(t),this.rpc.onTestRunEnd(r,"",!1)}onTestModuleCollected(e){this.rpc.onCollected(H(e),!1)}ensureSetupFileIsAllowed(e){[this.setupFilePaths.browserDebug].forEach(t=>{e.server.fs.allow.includes(t)||e.server.fs.allow.push(t)})}toJSON(){return{}}};function H(n){return n.task}async function $e(n,e,t){let r=e.meta,i=new k({setupFilePaths:r.setupFilePaths}),s,o;(r.shellType==="terminal"&&!r.hasShellIntegration||e.debug!=null)&&(s=new O.Writable({write(l,R,p){let g=l.toString();i.rpc&&i.rpc.onProcessLog("stdout",g).catch(()=>{}),process.stdout.write(g),p()}}),o=new O.Writable({write(l,R,p){let g=l.toString();i.rpc&&i.rpc.onProcessLog("stderr",g).catch(()=>{}),process.stderr.write(g),p()}}),globalThis.console=new J.Console(s,o));let a=r.arguments?n.parseCLI(r.arguments,{allowUnknownOptions:!1}).options:{},c=e.debug?{disableConsoleIntercept:!0,fileParallelism:!1,testTimeout:0,hookTimeout:0}:{},f={config:r.configFile,...a,...c,watch:!0,api:!1,reporter:void 0,reporters:[i],ui:!1,includeTaskLocation:!0,execArgv:r.pnpApi&&r.pnpLoader?["--require",r.pnpApi,"--experimental-loader",r.pnpLoader]:[]},u=await n.createVitest("test",f,{server:{middlewareMode:!0,watch:null},plugins:[{name:"vitest:vscode-extension",config(l){let p=(l.test??{}).coverage??{},N=(Array.isArray(p.reporter)?p.reporter:[p.reporter]).find(D=>D&&D[0]==="json"),ee=typeof N?.[1]=="object"?N[1]:{};return p.reporter=[["json",{...ee,file:r.finalCoverageFileName}]],{test:{printConsoleTrace:!0,coverage:{reportOnFailure:!0,reportsDirectory:(0,Y.join)((0,q.tmpdir)(),`vitest-coverage-${(0,K.randomUUID)()}`)}}}},configResolved(l){l.server.hmr={server:{on:()=>{},off:()=>{}}}},configureVitest(l){l.project.config.browser?.enabled&&typeof e.debug=="object"&&(l.project.config.setupFiles.push(r.setupFilePaths.browserDebug),l.vitest.config.inspector={enabled:!0,port:e.debug.port,host:e.debug.host,waitForDebugger:!1},l.project.config.inspector=l.vitest.config.inspector)},api:{vitest:{experimental:{ignoreFsModuleCache:!0}}}}]},{stderr:o,stdout:s});await u.report("onInit",u);let d=[u.getRootProject(),...u.projects].map(l=>l.vite.config.configFile).filter(l=>l!=null),m=u.config.projects!=null&&u.vite.config.configFile||!1;return{vitest:u,reporter:i,workspaceSource:m,configs:Array.from(new Set(d)),meta:r,createWorker(){return new v(u,!!e.debug,t)}}}0&&(module.exports={initVitest});
