#!/bin/bash
# GORUNFREE - Master Deployment Script
# One command = everything done

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
    echo ""
    echo "GORUNFREE - NOIZYLAB Master Command"
    echo ""
    echo "Usage: ./gorunfree [command] [options]"
    echo ""
    echo "Commands:"
    echo "  deploy [target]    Deploy to Cloudflare (all|repairs|edge|api)"
    echo "  status             Show all system status"
    echo "  sync               Sync GitHub repo"
    echo "  agent [name] [cmd] Invoke AI agent"
    echo "  db [action]        Database operations"
    echo "  aquarium [action]  Search THE_AQUARIUM archive (34TB)"
    echo "  repairs [action]   Search repair tickets"
    echo "  search [query]     Global search across all systems"
    echo "  help               Show this help"
    echo ""
}

# ═══════════════════════════════════════════════════════════════════════════════
# AQUARIUM ARCHIVE SEARCH (34TB Creative Archive)
# ═══════════════════════════════════════════════════════════════════════════════
aquarium() {
    local action=${1:-help}
    shift 2>/dev/null || true

    case $action in
        search)
            aquarium_search "$@"
            ;;
        list)
            aquarium_list "$@"
            ;;
        stats)
            aquarium_stats
            ;;
        help|*)
            echo ""
            echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
            echo -e "${GREEN}THE AQUARIUM - 34TB Creative Archive${NC}"
            echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
            echo ""
            echo "Usage: ./gorunfree aquarium [action] [options]"
            echo ""
            echo "Actions:"
            echo "  search <query>           Full-text search across archive"
            echo "  search --project <name>  Search by project name"
            echo "  search --year <range>    Search by year (e.g., 2005-2010)"
            echo "  search --format <fmt>    Search by format (Pro Tools, Logic, WAV, etc)"
            echo "  search --category <cat>  Search by category (music, sfx, voice, video)"
            echo "  list [category]          List items (optionally by category)"
            echo "  stats                    Show archive statistics"
            echo ""
            echo "Examples:"
            echo "  ./gorunfree aquarium search \"Ed Edd\""
            echo "  ./gorunfree aquarium search --year 2005-2010"
            echo "  ./gorunfree aquarium search --format \"Pro Tools\" --year 2008"
            echo "  ./gorunfree aquarium list music"
            echo ""
            ;;
    esac
}

aquarium_search() {
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}AQUARIUM SEARCH${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"

    local query=""
    local project=""
    local year=""
    local format=""
    local category=""
    local limit=50

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --project|-p)
                project="$2"
                shift 2
                ;;
            --year|-y)
                year="$2"
                shift 2
                ;;
            --format|-f)
                format="$2"
                shift 2
                ;;
            --category|-c)
                category="$2"
                shift 2
                ;;
            --limit|-l)
                limit="$2"
                shift 2
                ;;
            *)
                query="$1"
                shift
                ;;
        esac
    done

    # Build API request
    local api_url="https://noizylab-api.workers.dev/api/aquarium/search"
    local params=""

    [[ -n "$query" ]] && params="${params}&q=${query}"
    [[ -n "$project" ]] && params="${params}&project=${project}"
    [[ -n "$year" ]] && params="${params}&year=${year}"
    [[ -n "$format" ]] && params="${params}&format=${format}"
    [[ -n "$category" ]] && params="${params}&category=${category}"
    params="${params}&limit=${limit}"

    # Remove leading &
    params="${params:1}"

    echo -e "${YELLOW}Searching archive...${NC}"
    echo ""

    local response=$(curl -s "${api_url}?${params}" 2>/dev/null)

    if [[ -z "$response" || "$response" == *"error"* ]]; then
        # Fallback to local search if API not available
        echo -e "${YELLOW}API not available. Searching local archives...${NC}"
        aquarium_local_search "$query" "$project" "$year" "$format" "$category"
    else
        echo "$response" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if 'results' in data:
        print(f\"Found {len(data['results'])} items:\n\")
        for item in data['results']:
            print(f\"  [{item.get('category', 'unknown')}] {item.get('title', 'Untitled')}\")
            print(f\"    Project: {item.get('project', 'N/A')} | Year: {item.get('year', 'N/A')}\")
            print(f\"    Format: {item.get('format', 'N/A')} | Size: {item.get('size', 'N/A')}\")
            print(f\"    Location: {item.get('location', 'N/A')}\")
            print()
    else:
        print(json.dumps(data, indent=2))
except Exception as e:
    print(f'Parse error: {e}')
" 2>/dev/null || echo "$response"
    fi
}

aquarium_local_search() {
    local query="$1"
    local project="$2"
    local year="$3"
    local format="$4"
    local category="$5"

    # Search common archive locations
    local search_paths=(
        "/Volumes/THE_AQUARIUM"
        "/Volumes/AQUARIUM_*"
        "$HOME/THE_AQUARIUM"
        "/mnt/aquarium"
    )

    local found=0

    for base_path in "${search_paths[@]}"; do
        if [[ -d "$base_path" ]]; then
            echo -e "${GREEN}Searching: $base_path${NC}"

            # Build find command
            local find_cmd="find \"$base_path\" -type f"

            if [[ -n "$query" ]]; then
                find_cmd="$find_cmd -iname \"*${query}*\""
            fi

            if [[ -n "$format" ]]; then
                case "$format" in
                    "Pro Tools"|"protools"|"ptx")
                        find_cmd="$find_cmd -name \"*.ptx\" -o -name \"*.ptf\""
                        ;;
                    "Logic"|"logic")
                        find_cmd="$find_cmd -name \"*.logic\" -o -name \"*.logicx\""
                        ;;
                    "WAV"|"wav")
                        find_cmd="$find_cmd -name \"*.wav\""
                        ;;
                    "AIFF"|"aiff")
                        find_cmd="$find_cmd -name \"*.aiff\" -o -name \"*.aif\""
                        ;;
                    *)
                        find_cmd="$find_cmd -iname \"*.${format}\""
                        ;;
                esac
            fi

            eval "$find_cmd" 2>/dev/null | head -50 | while read -r file; do
                found=$((found + 1))
                local filename=$(basename "$file")
                local dirname=$(dirname "$file")
                local size=$(ls -lh "$file" 2>/dev/null | awk '{print $5}')
                echo -e "  ${GREEN}●${NC} $filename"
                echo -e "    Location: $dirname"
                echo -e "    Size: $size"
                echo ""
            done
        fi
    done

    if [[ $found -eq 0 ]]; then
        echo -e "${YELLOW}No local archives found. Mount THE_AQUARIUM volumes or use API.${NC}"
    fi
}

aquarium_list() {
    local category=${1:-all}
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}AQUARIUM LISTING: $category${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"

    curl -s "https://noizylab-api.workers.dev/api/aquarium/list?category=$category&limit=100" 2>/dev/null | \
        python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    for item in data.get('items', []):
        print(f\"  [{item.get('category')}] {item.get('title')}\")
except:
    print('API not available or no items found')
" 2>/dev/null || echo "API not available"
}

aquarium_stats() {
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}THE AQUARIUM - Archive Statistics${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo ""

    curl -s "https://noizylab-api.workers.dev/api/aquarium/stats" 2>/dev/null | \
        python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    print(f\"  Total Items:    {data.get('total_items', 'N/A')}\")
    print(f\"  Total Size:     {data.get('total_size', '34TB')}\")
    print(f\"  Categories:     {data.get('categories', 'N/A')}\")
    print(f\"  Year Range:     {data.get('year_range', 'N/A')}\")
    print(f\"  Formats:        {data.get('formats', 'N/A')}\")
    print()
    if 'by_category' in data:
        print('  By Category:')
        for cat, count in data['by_category'].items():
            print(f\"    {cat}: {count}\")
except Exception as e:
    print('Stats: 34TB archive spanning 40+ years')
    print('Categories: Music, SFX, Voice, Video, Samples')
" 2>/dev/null
}

# ═══════════════════════════════════════════════════════════════════════════════
# REPAIRS SEARCH
# ═══════════════════════════════════════════════════════════════════════════════
repairs_search() {
    local action=${1:-help}
    shift 2>/dev/null || true

    case $action in
        search)
            repairs_do_search "$@"
            ;;
        status)
            repairs_by_status "$@"
            ;;
        customer)
            repairs_by_customer "$@"
            ;;
        help|*)
            echo ""
            echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
            echo -e "${GREEN}NOIZYLAB REPAIRS SEARCH${NC}"
            echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
            echo ""
            echo "Usage: ./gorunfree repairs [action] [options]"
            echo ""
            echo "Actions:"
            echo "  search <query>         Search by ticket, name, or device"
            echo "  status <status>        List repairs by status (intake|in_progress|completed)"
            echo "  customer <name/email>  Find repairs by customer"
            echo ""
            echo "Examples:"
            echo "  ./gorunfree repairs search \"NZ-ABC123\""
            echo "  ./gorunfree repairs search \"MacBook\""
            echo "  ./gorunfree repairs status in_progress"
            echo "  ./gorunfree repairs customer \"john@example.com\""
            echo ""
            ;;
    esac
}

repairs_do_search() {
    local query="$1"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}REPAIRS SEARCH: $query${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"

    curl -s "https://noizylab-api.workers.dev/api/repairs/search?q=$query" 2>/dev/null | \
        python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    for r in data.get('repairs', []):
        print(f\"  [{r.get('status')}] {r.get('ticket_id')} - {r.get('customer_name')}\")
        print(f\"    Device: {r.get('device_type')} {r.get('device_model', '')}\")
        print(f\"    Issue: {r.get('issue_description', 'N/A')[:60]}...\")
        print(f\"    Created: {r.get('created_at')}\")
        print()
except Exception as e:
    print(f'Error: {e}')
" 2>/dev/null || echo "API error or no results"
}

repairs_by_status() {
    local status="$1"
    curl -s "https://noizylab-api.workers.dev/api/repairs/search?status=$status" 2>/dev/null | \
        python3 -m json.tool 2>/dev/null || echo "API not available"
}

repairs_by_customer() {
    local customer="$1"
    curl -s "https://noizylab-api.workers.dev/api/repairs/search?customer=$customer" 2>/dev/null | \
        python3 -m json.tool 2>/dev/null || echo "API not available"
}

# ═══════════════════════════════════════════════════════════════════════════════
# GLOBAL UNIFIED SEARCH
# ═══════════════════════════════════════════════════════════════════════════════
global_search() {
    local query="$1"

    if [[ -z "$query" ]]; then
        echo ""
        echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
        echo -e "${GREEN}GLOBAL SEARCH - Search Across All Systems${NC}"
        echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
        echo ""
        echo "Usage: ./gorunfree search <query>"
        echo ""
        echo "Searches across:"
        echo "  - THE AQUARIUM (34TB creative archive)"
        echo "  - Repair tickets and customers"
        echo "  - Knowledge Lake"
        echo "  - Agent memory"
        echo ""
        return
    fi

    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}GLOBAL SEARCH: $query${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo ""

    # Call unified search API
    local response=$(curl -s "https://noizylab-api.workers.dev/api/search?q=$query" 2>/dev/null)

    if [[ -n "$response" && "$response" != *"error"* ]]; then
        echo "$response" | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    total = data.get('total', 0)
    print(f'Found {total} results across all systems:\n')

    for source, results in data.get('results', {}).items():
        if results:
            print(f'── {source.upper()} ({len(results)} results) ──')
            for item in results[:5]:
                if source == 'aquarium':
                    print(f\"  ● {item.get('title')} [{item.get('category')}]\")
                elif source == 'repairs':
                    print(f\"  ● {item.get('ticket_id')} - {item.get('customer_name')}\")
                elif source == 'knowledge':
                    print(f\"  ● {item.get('title')} [{item.get('type')}]\")
                else:
                    print(f\"  ● {item}\")
            print()
except Exception as e:
    print(f'Parse error: {e}')
" 2>/dev/null || echo "$response"
    else
        # Fallback: search locally and via individual APIs
        echo -e "${YELLOW}Unified API not available. Searching individual systems...${NC}"
        echo ""

        echo -e "${GREEN}── REPAIRS ──${NC}"
        curl -s "https://noizylab-api.workers.dev/api/repairs/search?q=$query&limit=5" 2>/dev/null | \
            python3 -c "import sys,json; [print(f\"  ● {r.get('ticket_id')} - {r.get('customer_name')}\") for r in json.load(sys.stdin).get('repairs',[])]" 2>/dev/null || echo "  (not available)"

        echo ""
        echo -e "${GREEN}── AQUARIUM ──${NC}"
        aquarium_local_search "$query" "" "" "" "" 2>/dev/null | head -15

        echo ""
        echo -e "${GREEN}── KNOWLEDGE LAKE ──${NC}"
        curl -s "https://noizylab-api.workers.dev/api/knowledge/search?q=$query&limit=5" 2>/dev/null | \
            python3 -c "import sys,json; [print(f\"  ● {r.get('title')} [{r.get('type')}]\") for r in json.load(sys.stdin).get('results',[])]" 2>/dev/null || echo "  (not available)"
    fi
}

deploy() {
    local target=${1:-all}
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}GORUNFREE DEPLOY: $target${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    
    case $target in
        repairs|all)
            echo -e "${YELLOW}Deploying noizylab-repairs...${NC}"
            cd "$REPO_ROOT/business/noizylab-repairs"
            wrangler deploy
            echo -e "${GREEN}✓ noizylab-repairs deployed${NC}"
            ;;&
        edge|all)
            echo -e "${YELLOW}Deploying edge worker...${NC}"
            cd "$REPO_ROOT/infrastructure/cloudflare-workers/edge"
            [ -f wrangler.toml ] && wrangler deploy
            echo -e "${GREEN}✓ edge deployed${NC}"
            ;;&
    esac
    
    echo -e "${GREEN}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}DEPLOYMENT COMPLETE${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════${NC}"
}

status() {
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}NOIZYLAB SYSTEM STATUS${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    
    echo ""
    echo -e "${YELLOW}Cloudflare Workers:${NC}"
    wrangler whoami 2>/dev/null && wrangler deployments list 2>/dev/null || echo "Not authenticated"
    
    echo ""
    echo -e "${YELLOW}Git Status:${NC}"
    cd "$REPO_ROOT"
    git status -s
    
    echo ""
    echo -e "${YELLOW}Last Commit:${NC}"
    git log -1 --oneline
}

sync_repo() {
    echo -e "${BLUE}Syncing to GitHub...${NC}"
    cd "$REPO_ROOT"
    git add -A
    git commit -m "GORUNFREE sync $(date +%Y-%m-%d-%H%M)" || echo "Nothing to commit"
    git push origin main
    echo -e "${GREEN}✓ Synced to GitHub${NC}"
}

invoke_agent() {
    local agent=$1
    local command=$2
    echo -e "${BLUE}Invoking agent: $agent${NC}"
    echo -e "${YELLOW}Command: $command${NC}"
    # Agent invocation would go through Cloudflare Worker
    curl -X POST "https://noizylab-api.workers.dev/agent" \
        -H "Content-Type: application/json" \
        -d "{\"agent\": \"$agent\", \"command\": \"$command\"}" 2>/dev/null || \
        echo "Agent endpoint not deployed yet"
}

# Main command router
case ${1:-help} in
    deploy)
        deploy "$2"
        ;;
    status)
        status
        ;;
    sync)
        sync_repo
        ;;
    agent)
        invoke_agent "$2" "$3"
        ;;
    aquarium)
        shift
        aquarium "$@"
        ;;
    repairs)
        shift
        repairs_search "$@"
        ;;
    search)
        shift
        global_search "$@"
        ;;
    help|*)
        show_help
        ;;
esac
