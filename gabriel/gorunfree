#!/bin/bash
# GORUNFREE - Master Deployment Script
# One command = everything done

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}GORUNFREE - NOIZYLAB Master Command${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo ""
    echo "Usage: gorunfree [command] [options]"
    echo ""
    echo -e "${YELLOW}Deployment:${NC}"
    echo "  deploy [target]    Deploy to Cloudflare (all|repairs|edge|api)"
    echo "  sync               Sync GitHub repo"
    echo ""
    echo -e "${YELLOW}Status & Monitoring:${NC}"
    echo "  status             Show all system status"
    echo "  health             Quick health check"
    echo "  logs [worker]      Tail worker logs"
    echo ""
    echo -e "${YELLOW}AI Agents:${NC}"
    echo "  agent [name] [cmd] Invoke AI agent"
    echo "  gabriel            Launch GABRIEL system"
    echo "  brain              Launch God Brain"
    echo "  dream              Launch DreamChamber"
    echo ""
    echo -e "${YELLOW}Database:${NC}"
    echo "  db [action]        Database operations (list|query|backup)"
    echo ""
    echo -e "${YELLOW}Maintenance:${NC}"
    echo "  clean              Clean temp files and caches"
    echo "  maintain           Run daily maintenance"
    echo "  backup             Backup NOIZYLAB system"
    echo "  update             Update all dependencies"
    echo ""
    echo -e "${YELLOW}Help:${NC}"
    echo "  help               Show this help"
    echo "  version            Show version"
    echo ""
}

deploy() {
    local target=${1:-all}
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}GORUNFREE DEPLOY: $target${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    
    case $target in
        repairs|all)
            echo -e "${YELLOW}Deploying noizylab-repairs...${NC}"
            cd "$REPO_ROOT/business/noizylab-repairs"
            wrangler deploy
            echo -e "${GREEN}✓ noizylab-repairs deployed${NC}"
            ;;&
        edge|all)
            echo -e "${YELLOW}Deploying edge worker...${NC}"
            cd "$REPO_ROOT/infrastructure/cloudflare-workers/edge"
            [ -f wrangler.toml ] && wrangler deploy
            echo -e "${GREEN}✓ edge deployed${NC}"
            ;;&
    esac
    
    echo -e "${GREEN}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}DEPLOYMENT COMPLETE${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════${NC}"
}

status() {
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}NOIZYLAB SYSTEM STATUS${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    
    echo ""
    echo -e "${YELLOW}Cloudflare Workers:${NC}"
    wrangler whoami 2>/dev/null && wrangler deployments list 2>/dev/null || echo "Not authenticated"
    
    echo ""
    echo -e "${YELLOW}Git Status:${NC}"
    cd "$REPO_ROOT"
    git status -s
    
    echo ""
    echo -e "${YELLOW}Last Commit:${NC}"
    git log -1 --oneline
}

sync_repo() {
    echo -e "${BLUE}Syncing to GitHub...${NC}"
    cd "$REPO_ROOT"
    git add -A
    git commit -m "GORUNFREE sync $(date +%Y-%m-%d-%H%M)" || echo "Nothing to commit"
    git push origin main
    echo -e "${GREEN}✓ Synced to GitHub${NC}"
}

invoke_agent() {
    local agent=$1
    local command=$2
    echo -e "${BLUE}Invoking agent: $agent${NC}"
    echo -e "${YELLOW}Command: $command${NC}"
    # Agent invocation would go through Cloudflare Worker
    curl -X POST "https://noizylab-api.workers.dev/agent" \
        -H "Content-Type: application/json" \
        -d "{\"agent\": \"$agent\", \"command\": \"$command\"}" 2>/dev/null || \
        echo "Agent endpoint not deployed yet"
}

health_check() {
    echo -e "${BLUE}Quick Health Check...${NC}"

    # Workers
    local worker_status=$(curl -s -o /dev/null -w '%{http_code}' https://noizylab.rsplowman.workers.dev/health 2>/dev/null)
    [ "$worker_status" = "200" ] && echo -e "${GREEN}[OK] Cloudflare Workers${NC}" || echo -e "${RED}[!!] Workers: $worker_status${NC}"

    # Tailscale
    tailscale status &>/dev/null && echo -e "${GREEN}[OK] Tailscale VPN${NC}" || echo -e "${YELLOW}[--] Tailscale not running${NC}"

    # Ollama
    curl -s http://localhost:11434/api/tags &>/dev/null && echo -e "${GREEN}[OK] Ollama${NC}" || echo -e "${YELLOW}[--] Ollama not running${NC}"

    # Disk space
    local disk_pct=$(df -h / | tail -1 | awk '{print $5}' | tr -d '%')
    [ "$disk_pct" -lt 90 ] && echo -e "${GREEN}[OK] Disk: ${disk_pct}% used${NC}" || echo -e "${RED}[!!] Disk: ${disk_pct}% used${NC}"
}

tail_logs() {
    local worker=${1:-noizylab-main}
    echo -e "${BLUE}Tailing logs for $worker...${NC}"
    cd "$REPO_ROOT/workers/$worker" 2>/dev/null && wrangler tail || echo "Worker not found: $worker"
}

launch_gabriel() {
    echo -e "${BLUE}Launching GABRIEL...${NC}"
    python3 "$REPO_ROOT/gabriel.py" "$@"
}

launch_brain() {
    echo -e "${BLUE}Activating God Brain...${NC}"
    python3 "$REPO_ROOT/brain/god_brain.py" "$@" 2>/dev/null || \
        python3 "$REPO_ROOT/CODEMASTER/master_orchestrator.py" "$@"
}

launch_dream() {
    echo -e "${BLUE}Entering DreamChamber...${NC}"
    python3 "$REPO_ROOT/core/dreamchamber.py" "$@" 2>/dev/null || \
        echo "DreamChamber not installed"
}

db_operations() {
    local action=${1:-list}
    echo -e "${BLUE}Database: $action${NC}"
    case $action in
        list)
            wrangler d1 list 2>/dev/null || echo "D1 not configured"
            ;;
        query)
            local db=${2:-noizylab-repairs}
            local sql="$3"
            wrangler d1 execute "$db" --command="$sql"
            ;;
        backup)
            echo "Backup feature coming soon..."
            ;;
    esac
}

clean_system() {
    echo -e "${BLUE}Cleaning system...${NC}"

    # Clean Python cache
    find "$REPO_ROOT" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null
    find "$REPO_ROOT" -type f -name "*.pyc" -delete 2>/dev/null

    # Clean node modules cache
    find "$REPO_ROOT" -name ".cache" -type d -exec rm -rf {} + 2>/dev/null

    # Clean logs older than 7 days
    find "$REPO_ROOT/logs" -type f -mtime +7 -delete 2>/dev/null

    echo -e "${GREEN}[OK] Cleanup complete${NC}"
}

update_deps() {
    echo -e "${BLUE}Updating dependencies...${NC}"

    # NPM
    if [ -f "$REPO_ROOT/package.json" ]; then
        cd "$REPO_ROOT" && npm update
    fi

    # Wrangler
    npm update -g wrangler 2>/dev/null

    echo -e "${GREEN}[OK] Dependencies updated${NC}"
}

# Main command router
case ${1:-help} in
    deploy)
        deploy "$2"
        ;;
    status)
        status
        ;;
    health)
        health_check
        ;;
    logs)
        tail_logs "$2"
        ;;
    sync)
        sync_repo
        ;;
    agent)
        invoke_agent "$2" "$3"
        ;;
    gabriel)
        launch_gabriel "${@:2}"
        ;;
    brain)
        launch_brain "${@:2}"
        ;;
    dream)
        launch_dream "${@:2}"
        ;;
    db)
        db_operations "$2" "$3" "$4"
        ;;
    clean)
        clean_system
        ;;
    maintain)
        "$REPO_ROOT/scripts/daily_maintenance.sh"
        ;;
    backup)
        "$REPO_ROOT/scripts/backup_noizylab.sh"
        ;;
    update)
        update_deps
        ;;
    version)
        echo "GORUNFREE v2.0 - NOIZYLAB Master Command"
        echo "Built for MC96ECOUNIVERSE"
        ;;
    help|*)
        show_help
        ;;
esac
