(self.webpackChunk=self.webpackChunk||[]).push([[5320],{78322:(e,t,s)=>{s.d(t,{N:()=>n});var i=s(8867);function n(e){return new i.y((t=>{const s=new DisposableStack,i=s.use(e());return s.adopt(i.subscribe((e=>t.next(e))),(e=>e.unsubscribe())),()=>s.dispose()}))}},16667:(e,t,s)=>{s.d(t,{D8:()=>n.D,N4:()=>r.N,TJ:()=>n.T,kX:()=>i.k});var i=s(58431),n=s(26631),r=s(78322)},15844:(e,t,s)=>{s.r(t),s.d(t,{AgentsSidePanelIntegration:()=>gt});var i=s(92379),n=s(73642),r=s(90572),o=s(24666),a=s(20161),l=s(84714),c=(s(24231),s(11970),s(27841),s(66445),s(16667)),d=s(13391),u=s(57747),h=s(39963),p=s(78767),m=s(40594),g=s(52561),b=s(99161),v=s(89662),f=s(70512);const k={events:{documentSessionDisposed:(0,v.d)()},state:{activeTabId:(0,f.x)(),"activeDocument/:tabId":(0,f.x)(),"agentsFeatureFlags/:tabId":(0,f.x)(),lastActivePanelAgentId:(0,f.x)(),activePanelAgentId:(0,f.x)()}};var y,w,I,_=s(74822),S=s(21070),P=s(79256),C=s(18519),A=s(71051),M=s(63532),x=s(66878),D=s(36344),B=e=>{throw TypeError(e)},W=(e,t,s)=>t.has(e)||B("Cannot "+s),E=(e,t,s)=>(W(e,t,"read from private field"),s?s.call(e):t.get(e)),T=(e,t,s)=>t.has(e)?B("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),O=(e,t,s,i)=>(W(e,t,"write to private field"),t.set(e,s),s);class N{constructor(e){T(this,y,new DisposableStack),T(this,w,new Map),T(this,I),O(this,I,e)}send(e){E(this,I).send(e)}subscribe(e){const t=new DisposableStack;t.defer((()=>{const t=E(this,w).get(e);null==t||t[Symbol.dispose](),E(this,w).delete(e)}));const s=new DisposableStack;return E(this,w).set(e,s),null!==E(this,I)&&s.use(E(this,I).subscribe(e)),t}connectToServerPort(e){O(this,I,e);for(const[e,t]of E(this,w)){t[Symbol.dispose]();const s=E(this,I).subscribe(e);E(this,w).set(e,s)}}[Symbol.dispose](){E(this,y).dispose()}}y=new WeakMap,w=new WeakMap,I=new WeakMap;var $=s(23537),R=s(57206),j=s(1933);function F(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;if(Array.isArray(e)&&Array.isArray(t))return e.length===t.length&&e.every(((e,s)=>F(e,t[s])));if(Array.isArray(e)!==Array.isArray(t))return!1;const s=Object.keys(e),i=new Set(Object.keys(t));if(s.length!==i.size)return!1;for(const n of s)if(!i.has(n)||!F(e[n],t[n]))return!1;return!0}var G,Y,V,H,z,q,X,K,L,J,Q,U,Z,ee,te,se,ie,ne,re,oe,ae,le,ce,de,ue,he,pe,me,ge,be,ve,fe,ke,ye,we,Ie,_e=s(83535),Se=Object.defineProperty,Pe=Object.defineProperties,Ce=Object.getOwnPropertyDescriptors,Ae=Object.getOwnPropertySymbols,Me=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable,De=e=>{throw TypeError(e)},Be=(e,t,s)=>t in e?Se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,We=(e,t)=>{for(var s in t||(t={}))Me.call(t,s)&&Be(e,s,t[s]);if(Ae)for(var s of Ae(t))xe.call(t,s)&&Be(e,s,t[s]);return e},Ee=(e,t,s)=>t.has(e)||De("Cannot "+s),Te=(e,t,s)=>(Ee(e,t,"read from private field"),s?s.call(e):t.get(e)),Oe=(e,t,s)=>t.has(e)?De("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),Ne=(e,t,s,i)=>(Ee(e,t,"write to private field"),t.set(e,s),s),$e=(e,t,s)=>(Ee(e,t,"access private method"),s);class Re{constructor(e){var t,s;Oe(this,U),Oe(this,G,new DisposableStack),Oe(this,Y),Oe(this,V),Oe(this,H),Oe(this,z),Oe(this,q,!1),Oe(this,X,null),Oe(this,K,Te(this,G).adopt(new Map,(e=>e.clear()))),Oe(this,L,Te(this,G).adopt(new Map,(e=>e.clear()))),Oe(this,J,Te(this,G).adopt(new Map,(e=>e.clear()))),Oe(this,Q,Te(this,G).adopt(new Map,(e=>e.clear()))),Ne(this,Y,e.serverPort),Ne(this,V,null!=(t=e.tracingOptions)?t:{enabled:!1}),Ne(this,H,e.retainedValueStorage),Ne(this,z,`${(0,_e.v)()}${void 0!==e.name?`(${e.name})`:""}`),Te(this,G).use(null==(s=Te(this,Y))?void 0:s.subscribe((e=>$e(this,U,ee).call(this,e)))),Te(this,G).defer((()=>{var t;return null==(t=e.retainedValueStorage)?void 0:t.clear()})),void 0!==Te(this,Y)&&this.connect()}isConnected(){return!Te(this,q)}waitConnected(){var e,t;return null!=(t=null==(e=Te(this,X))?void 0:e.promise)?t:Promise.resolve()}connect(){var e;if(!Te(this,Y))return Promise.resolve();null==(e=Te(this,X))||e.reject(new Error("Connection attempt superseded by a newer one")),Ne(this,q,!0),Te(this,Q).forEach((e=>e.setBufferingEnabled(!0)));const t=`${Te(this,z)}|${(0,_e.v)()}`,s=(0,j.B)();return Ne(this,X,{attempId:t,resolve:()=>{var e;(null==(e=Te(this,X))?void 0:e.attempId)===t&&(Ne(this,q,!1),Ne(this,X,null),Te(this,Q).forEach((e=>e.setBufferingEnabled(!1))),s.resolve())},reject:e=>{var i;(null==(i=Te(this,X))?void 0:i.attempId)===t&&(Ne(this,q,!1),Ne(this,X,null),s.reject(e))},promise:s.promise}),Te(this,Y).send({kind:"handshake",id:t,subscriptions:[...Te(this,K).values()].map((e=>({key:e.key,clientId:e.clientId,subscriptionId:e.portId,timestamp:e.timestamp}))),retainedValues:[...Te(this,J).entries()].map((([e,t])=>({key:e,value:t.value,clientId:t.lastWriterClientId,timestamp:t.modifiedTimestamp})))}),s.promise}createPort(e){const t=null==e?void 0:e.name,s=`${Te(this,z)}|${(0,_e.v)()}${void 0!==t?`(${t})`:""}`,i=Te(this,G).use(new je({send:e=>$e(this,U,ie).call(this,s,e),notifyDispose:()=>$e(this,U,Z).call(this,s),shouldBufferMessages:Te(this,q),tracingOptions:void 0!==(null==e?void 0:e.tracingOptions)?e.tracingOptions:Te(this,V),portId:s}));return Te(this,Q).set(s,i),i}[Symbol.dispose](){Te(this,G).dispose()}}G=new WeakMap,Y=new WeakMap,V=new WeakMap,H=new WeakMap,z=new WeakMap,q=new WeakMap,X=new WeakMap,K=new WeakMap,L=new WeakMap,J=new WeakMap,Q=new WeakMap,U=new WeakSet,Z=function(e){const t=Te(this,Q).get(e);if(void 0!==t){for(const[t,s]of Te(this,K).entries())s.portId===e&&$e(this,U,ce).call(this,e,{kind:"unsubscribe",subscriptionId:t});t[Symbol.dispose](),Te(this,Q).delete(e)}},ee=function(e){switch(e.kind){case"publish":$e(this,U,se).call(this,e);break;case"handshake-ack":$e(this,U,te).call(this,e)}},te=function(e){var t,s;if((null==(t=Te(this,X))?void 0:t.attempId)===e.id){Te(this,X).resolve();for(const t of e.newerRetainedValues)Te(this,J).set(t.key,{value:t.value,lastWriterClientId:t.clientId,modifiedTimestamp:t.timestamp}),null==(s=Te(this,H))||s.set(t.key,t.value),$e(this,U,he).call(this,{kind:"publish",key:t.key,value:t.value,timestamp:t.timestamp,clientId:t.clientId})}},se=function(e){var t,s;const i=Te(this,J).get(e.key);if(void 0!==i){if(e.timestamp<=i.modifiedTimestamp)return;Te(this,J).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(t=Te(this,H))||t.set(e.key,e.value)}if(null==(s=e.route)||!s.includes(Te(this,z)))return void 0!==e.toSubscriptionId?$e(this,U,de).call(this,e):void 0!==e.toClientId?$e(this,U,ue).call(this,e):$e(this,U,he).call(this,e)},ie=function(e,t){switch(t.kind){case"publish":$e(this,U,ne).call(this,t);break;case"subscribe":$e(this,U,oe).call(this,e,t);break;case"unsubscribe":$e(this,U,ce).call(this,e,t);break;case"handshake":$e(this,U,re).call(this,e,t)}},ne=function(e){var t,s,i;const n=Te(this,J).get(e.key);void 0!==n&&e.timestamp>n.modifiedTimestamp?(Te(this,J).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(t=Te(this,H))||t.set(e.key,e.value)):void 0!==n&&$e(this,U,ue).call(this,{kind:"publish",key:e.key,value:n.value,timestamp:n.modifiedTimestamp,clientId:n.lastWriterClientId,route:[Te(this,z)],toClientId:e.clientId});const r=((e,t)=>Pe(e,Ce(t)))(We({},e),{route:[...null!=(s=e.route)?s:[],Te(this,z)]});void 0!==e.toClientId?$e(this,U,ue).call(this,r):$e(this,U,he).call(this,r),null==(i=Te(this,Y))||i.send(r)},re=function(e,t){var s,i;const n=Te(this,Q).get(e);if(void 0===n)return void(0,$.P)("No port for handshake message",e);for(const s of t.subscriptions)$e(this,U,ae).call(this,{key:s.key,portId:e,timestamp:s.timestamp,clientId:s.clientId,subscriptionId:s.subscriptionId});const r=[],o=[];for(const e of t.retainedValues){const t=Te(this,J).get(e.key);void 0!==t&&t.modifiedTimestamp>=e.timestamp?r.push({key:e.key,value:t.value,timestamp:t.modifiedTimestamp,clientId:t.lastWriterClientId}):(Te(this,J).set(e.key,{value:e.value,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(s=Te(this,H))||s.set(e.key,e.value),o.push({key:e.key,value:e.value,timestamp:e.timestamp,clientId:e.clientId}))}n.outbound({kind:"handshake-ack",id:t.id,newerRetainedValues:r}),null==(i=Te(this,Y))||i.send(t);for(const e of o)$e(this,U,he).call(this,{kind:"publish",key:e.key,value:e.value,timestamp:e.timestamp,clientId:e.clientId,route:[Te(this,z)],excludeSubscriptionIds:t.subscriptions.map((e=>e.subscriptionId))})},oe=function(e,t){var s;Te(this,K).has(t.subscriptionId)?(0,$.P)("Subscription with this id already exists",t.subscriptionId):($e(this,U,ae).call(this,We({portId:e},t)),void 0!==t.retain&&$e(this,U,le).call(this,t,t.retain.value,e),null==(s=Te(this,Y))||s.send(t))},ae=function(e){const t={key:e.key,portId:e.portId,timestamp:e.timestamp,clientId:e.clientId};Te(this,K).set(e.subscriptionId,t);let s=Te(this,L).get(e.key);void 0===s&&(s=new Set,Te(this,L).set(e.key,s)),s.add(e.subscriptionId)},le=function(e,t,s){var i,n,r,o,a;if("write"===(null==(i=e.retain)?void 0:i.kind)&&e.timestamp>(null!=(r=null==(n=Te(this,J).get(e.key))?void 0:n.modifiedTimestamp)?r:Number.MIN_SAFE_INTEGER)&&!F(t,null==(o=Te(this,J).get(e.key))?void 0:o.value))Te(this,J).set(e.key,{value:t,lastWriterClientId:e.clientId,modifiedTimestamp:e.timestamp}),null==(a=Te(this,H))||a.set(e.key,t),void 0!==Te(this,Q).get(s)&&$e(this,U,he).call(this,{kind:"publish",key:e.key,value:t,timestamp:e.timestamp,clientId:e.clientId,route:[Te(this,z)],excludeSubscriptionIds:[e.subscriptionId]});else{const i=Te(this,J).get(e.key);if(void 0===i)return;void 0!==Te(this,Q).get(s)&&!F(t,i.value)&&$e(this,U,de).call(this,{kind:"publish",key:e.key,value:i.value,timestamp:i.modifiedTimestamp,clientId:i.lastWriterClientId,route:[Te(this,z)],toSubscriptionId:e.subscriptionId})}},ce=function(e,t){var s,i;const n=Te(this,K).get(t.subscriptionId);if(void 0===n)return void(0,$.P)("No subscription with this id",t.subscriptionId);if(n.portId!==e)return void(0,$.P)("Subscription does not belong to this port",t.subscriptionId,e);Te(this,K).delete(t.subscriptionId);const r=Te(this,L).get(n.key);void 0!==r&&(r.delete(t.subscriptionId),0===r.size&&(Te(this,L).delete(n.key),Te(this,J).delete(n.key),null==(s=Te(this,H))||s.delete(n.key))),null==(i=Te(this,Y))||i.send(t)},de=function(e){const t=Te(this,K).get(e.toSubscriptionId);if(void 0===t)return void(0,$.P)("No subscription with this id",e.toSubscriptionId);const s=Te(this,Q).get(t.portId);void 0!==s?s.outbound(e):(0,$.P)("No port for subscription with this id",e.toSubscriptionId)},ue=function(e){const t=$e(this,U,pe).call(this,e.key,e.toClientId,void 0);for(const s of t)s.outbound(e)},he=function(e){const t=$e(this,U,pe).call(this,e.key,void 0,e.excludeSubscriptionIds);for(const s of t)s.outbound(e)},pe=function(e,t,s){const i=new Set,n=Te(this,L).get(e);for(const e of null!=n?n:[]){if(s&&s.includes(e))continue;const n=Te(this,K).get(e);if(void 0===n||void 0!==t&&t!==n.clientId)continue;const r=Te(this,Q).get(n.portId);void 0!==r&&i.add(r)}return i};class je{constructor(e){var t;Oe(this,ye),Oe(this,me,new DisposableStack),Oe(this,ge),Oe(this,be),Oe(this,ve,Te(this,me).use(new R.x)),Oe(this,fe,[]),Oe(this,ke),Ne(this,be,e.send),Ne(this,ke,e.shouldBufferMessages),Te(this,me).defer((()=>e.notifyDispose())),Ne(this,ge,null!=(t=e.tracingOptions)?t:{enabled:!1}),this.portId=e.portId}send(e){$e(this,ye,Ie).call(this,"inbound",e),Te(this,ke)&&"handshake"!==e.kind?Te(this,fe).push(e):($e(this,ye,we).call(this),Te(this,be).call(this,e))}subscribe(e){const t=new DisposableStack;return Te(this,me).defer((()=>t.dispose())),t.use(Te(this,ve).subscribe({next:e,complete:()=>t.dispose()})),t}[Symbol.dispose](){Te(this,me).dispose()}outbound(e){$e(this,ye,Ie).call(this,"outbound",e),Te(this,ve).next(e)}setBufferingEnabled(e){Ne(this,ke,e),e||$e(this,ye,we).call(this)}}me=new WeakMap,ge=new WeakMap,be=new WeakMap,ve=new WeakMap,fe=new WeakMap,ke=new WeakMap,ye=new WeakSet,we=function(){if(Te(this,fe).length>0){for(const e of Te(this,fe))Te(this,be).call(this,e);Te(this,fe).length=0}},Ie=function(e,t){};class Fe extends Re{constructor(e){super(e)}}class Ge{constructor(e){this._init=e,this._disposables=new DisposableStack,this._logger=m.Y.create("AgentsReconnectingMessageBusRouterClient"),this._telemetry="cs"===this._init.script?(0,h.Tb)().agents.cs():(0,h.Tb)().agents.sidePanel,this._reconnectSubject=new _.x,this._volatileMessageBusServerPort=this._getNewPort(),this._messageBusServerPort=this._disposables.use(new N(this._volatileMessageBusServerPort)),this._messageBusContentScriptRouter=this._disposables.use(new Fe({tracingOptions:{enabled:!1,color:"green"},serverPort:this._messageBusServerPort,name:this._init.routerName})),this._isEarlyDisconnectHandlerEnabled=this._init.isEarlyDisconnectHandlerEnabled,this._disposables.defer((()=>this._volatileMessageBusServerPort[Symbol.dispose]()));let t=0;this._disposables.adopt(this._reconnectSubject.pipe((0,S.z)((()=>{var e,s;return(0,P.P)((()=>{this._logger.info("Reconnecting to message bus server... Attempt #"+ ++t);const e=this._volatileMessageBusServerPort;return this._volatileMessageBusServerPort=this._getNewPort(),this._messageBusServerPort.connectToServerPort(this._volatileMessageBusServerPort),e[Symbol.dispose](),this._messageBusContentScriptRouter.connect()})).pipe((0,C.V)(null!==(e=this._init.reconnectTimeoutMs)&&void 0!==e?e:1e3),(0,A.X)({count:null!==(s=this._init.reconnectMaxAttempts)&&void 0!==s?s:5}),(0,M.b)((()=>{this._logger.info("Reconnected to message bus server"),t=0})),(0,x.K)((e=>(this._telemetry.error("Failed to reconnect to message bus server",e),this._logger.error("Failed to reconnect to message bus server",e),D.E))))}))).subscribe(),(e=>e.unsubscribe()))}createPort(...e){return this._messageBusContentScriptRouter.createPort(...e)}[Symbol.dispose](){this._disposables.dispose()}_getNewPort(){return function(e,t,s,i){let n=!0;const r=new DisposableStack,o=e();r.defer((()=>{var e;return null===(e=o.removeMessageListeners)||void 0===e?void 0:e.call(o)}));const a=new _.x,l=()=>{var e;n||!i?(n=!1,r.disposed||(null===(e=o.removeMessageListeners)||void 0===e||e.call(o),t())):m.Y.create("createClientPort").debug("Disconnect already handled, skipping")};return o.onDisconnect((()=>{l()})),o.onMessage((e=>{r.disposed||a.next(e)})),{send:e=>{if(r.disposed||!n)return s.warn("Cannot send message to a disposed BG port"),void m.Y.create("createClientPort").warn("Cannot send message to a disposed BG port");try{o.postMessage(e)}catch(e){i&&l(),s.warn("Error sending message to BG port",e,{isEarlyDisconnectHandlerEnabled:i}),m.Y.create("createClientPort").error("Error sending message to BG port",e)}},subscribe:e=>{if(r.disposed||!n)return s.warn("Cannot subscribe to a disposed BG port"),m.Y.create("createClientPort").warn("Cannot subscribe to a disposed BG port"),new DisposableStack;const t=r.use(new DisposableStack);return t.adopt(a.subscribe(e),(e=>e.unsubscribe())),t},[Symbol.dispose]:()=>r.dispose()}}(this._init.createContentScriptPort,(()=>this._reconnectSubject.next()),this._telemetry,this._isEarlyDisconnectHandlerEnabled)}}function Ye(e){return`agents/${e}`}function Ve(e,...t){return He(e,...t)}function He(e,...t){return`agents/@impl/${e}${Ke(t)}`}function ze(e,t,...s){return qe(e,t,...s)}function qe(e,t,...s){return`${Ye(e)}/${t}${Ke(s)}`}function Xe(e,...t){return`agents/${e}${Ke(t)}`}function Ke(e){const t=e.filter(Boolean).join("/");return t?`/${t}`:""}var Le=s(24196);class Je{constructor(e){this._disposables=new DisposableStack;const t=e.experimentClient.isGateEnabled(Le.Nl.AgentsEarlyDisconnectHandler);this._messageBusRouter=this._disposables.use(new Ge({script:e.script,createContentScriptPort:()=>e.messageApi.createPortConnection(b.Tt.messageBusPort),routerName:Xe(e.script,e.tabId),isEarlyDisconnectHandlerEnabled:t})),this.platformBus=this._disposables.use((0,c.kX)({port:this._messageBusRouter.createPort({name:Ve(e.script,e.tabId)}),clientId:He(e.script,e.tabId),keyPrefix:"agents/@impl",protocol:k}))}createPort(...e){return this._messageBusRouter.createPort(...e)}[Symbol.dispose](){this._disposables.dispose()}}var Qe=s(33872),Ue=s(62835),Ze=s(29392),et=s(24704),tt=s(85263);const st={[s(11087).f.id]:"ReaderReactions",[Ze.f.id]:"Humanizer",[et.f.id]:"Paraphraser",[Ue.f.id]:"ExpertReview",[Qe.f.id]:"AIDetector",[tt.f.id]:"Plagiarism"};var it=s(23162);class nt{constructor(e){this._experimentClient=e}isAssigned(e,...t){if(e instanceof it.Cc)return this._experimentClient.isGateEnabled(e);const s=this._experimentClient.getTreatment(e);return null!==s&&s!==it.q4&&t.includes(s)}getTreatment(e){const t=this._experimentClient.getTreatment(e);return t===it.q4?null:t}peekExperiment(e,...t){const s=this._experimentClient.peekTreatment(e);return null!==s&&s!==it.q4&&t.includes(s)}}var rt=s(12518),ot=s(42101),at=s(11476);const lt=e=>{const t=new Set;return"edge"!==e.browser&&"msie"!==e.browser&&t.add(at.L.Flag.supportsSVGDominantBaseline),{has:e=>t.has(e)}};class ct{constructor(){this.openUrl=e=>(0,rt.Y3)((()=>{document.location.href=e.toString()}),rt.KC),this.openPopup=e=>(0,rt.Y3)((()=>{const t=self.open(e.toString(),"_blank","noopener,noreferrer");t&&(t.opener=null)}),rt.KC)}}var dt=s(40795);function ut(e){return{[Symbol.asyncDispose]:async()=>{if(!e)return;const t=await e;t&&(!function(e){return Symbol.dispose in e}(t)?function(e){return Symbol.asyncDispose in e}(t)&&await t[Symbol.asyncDispose]():t[Symbol.dispose]())}}}var ht=s(72),pt=s(42082);function mt(){const e=m.Y.create("useOpenChatWithMessage"),{commandExecutor:t}=(0,ht.ar)();return s=>{t?(e.debug("Opening chat agent with message:",s),t.execute({kind:ht.FP.MessageAgent,agentId:pt._N,message:{kind:ht.IQ.Command,command:{kind:ht.pd.CreateChat,message:{content:s}}}}),t.execute({kind:ht.FP.OpenAgent,agentId:pt._N})):e.error("Command executor or send message not available")}}class gt{constructor(e){this._initOptions=e,this._disposables=new AsyncDisposableStack,this._logger=m.Y.create("Agents.SidePanelIntegration"),this._experimentationService=new nt(this._initOptions.experimentClient),this._agentDefinitions=(0,dt.c)(this._initOptions.experimentClient),this._messageBusClient=this._disposables.use(new Je({messageApi:(0,g.O)().browserApi.message,script:"side-panel",experimentClient:this._initOptions.experimentClient})),this._agentPlatformBus=this._messageBusClient.platformBus,this._activePanelAgentId=this._disposables.use(this._agentPlatformBus.state.lastActivePanelAgentId.create(null))}setActiveAgentId(e){this._activePanelAgentId.set(e)}loadAssistantAgents(){if(!(0,Le.w4)(this._initOptions.experimentClient))return d.h.create([]);const e=this._runAssistantActivations(),t=d.h.create(new Map(e.map((e=>[e.agentId,null]))));for(const s of e){const{agentId:e,integrationResult:n}=s;n.then((s=>{s?t.modify((t=>{const n=i.memo((e=>s.renderIcon(e)));n.displayName=`Icon-${e}`;const r=i.memo((()=>{const e=mt();return s.renderPanel({onClosePanel:void 0,onChatAIMessage:e})}));return r.displayName=`Panel-${e}`,new Map(t).set(e,{id:e,title:s.title,renderPanel:()=>i.createElement(r),renderIcon:e=>i.createElement(n,e)})})):this._logger.debug(`Agent ${e} was not activated due to allowed features check`)})).catch((t=>{this._logger.error(`Failed to get assistant integration result for agent ${e}`,t),(0,h.Tb)().agents.sidePanel.error("Failed to get assistant integration result for agent",t,{agentId:e})}))}return t.view((e=>[...e.values()].filter(p.C_)))}async _getAllowedFeatures(){if(!this._initOptions.experimentClient.isGateEnabled(Le.Nl.AgentsCAPIFiltering))return this._logger.debug("CAPI filtering gate is disabled, using all agents"),null;const e=this._initOptions.checkingServiceProvider.getCheckingService();if(!e)return this._logger.debug("No checking service available, skipping all agents"),[];try{const t=e=>"start"===e.action,s=(await(0,n.z)(e.capiMessages.pipe((0,r.h)(t)))).allowedFeatures||[];return this._logger.debug("Received allowed features from CAPI:",s),s}catch(e){return this._logger.error("Failed to get allowed features from CAPI:",e),[]}}_runAssistantActivations(){const e=u.W.detect(),t=function(e){return new ot.f(lt(e),new ct)}(e),s=this._disposables.use(function(e){const t=new DisposableStack,s=t.use(e.state.activeTabId.view(null)),i=d.h.create(null);return t.adopt(s.pipe((0,o.x)(),(0,a.w)((t=>null===t?(0,l.of)(null):(0,c.N4)((()=>e.state.activeDocument.view(t,null)))))).subscribe((e=>i.set(e))),(e=>e.unsubscribe())),{activeDocument:i,[Symbol.dispose]:()=>t.dispose()}}(this._agentPlatformBus)).activeDocument,i=this._disposables.use(this._agentPlatformBus.state.activeTabId.view(null)),n=d.h.create(null);this._disposables.adopt(i.pipe((0,o.x)(),(0,a.w)((e=>null===e?(0,l.of)(null):(0,c.N4)((()=>this._agentPlatformBus.state.agentsFeatureFlags.view(e,null)))))).subscribe((e=>n.set(e))),(e=>e.unsubscribe()));const r={user:this._initOptions.user.view((e=>({id:e.id,firstName:e.firstName,email:e.email,free:!e.premium,anonymous:e.anonymous})))},p=this._getAllowedFeatures();return this._agentDefinitions.map((i=>{const o=p.then((async o=>{var a,l;if(null!==o){const e=dt.v[i.id];if(e&&!o.includes(e))return this._logger.debug(`Agent ${i.id} requires feature ${e} which is not in allowed features, skipping activation`),null}this._logger.debug(`Running assistant activation for ${i.id}`);const u=new AsyncDisposableStack;this._disposables.defer((()=>u.disposeAsync()));const p=u.use(this._messageBusClient.createPort({name:ze(i.id,"assistant")})),m=d.h.combine(s,n,((e,t)=>{var s;if(!e)return null;const n=st[i.id],r=!!t&&(null!==(s=t[n])&&void 0!==s&&s);return{...e,supportsAgents:e.supportsAgents&&r}})),g={activeDocument:m,documentSessionDisposed:this._agentPlatformBus.events.documentSessionDisposed.view()};try{const s=null===(l=(a=i.integrations).assistantActivate)||void 0===l?void 0:l.call(a,{bus:u.use((0,c.kX)({port:p,clientId:qe(i.id,"assistant"),keyPrefix:Ye(i.id),protocol:i.protocol})),documents:g,navigation:{isPanelOpen:this._activePanelAgentId.view((e=>e===i.id))},experimentation:this._experimentationService,platformInfo:e,environment:t,userService:r});return s?(u.use(ut(s.catch((()=>null)))),s):(u.disposeAsync(),null)}catch(e){return u.disposeAsync(),this._logger.error(`Assistant activation error for agent ${i.id}`,e),(0,h.Tb)().agents.sidePanel.error("Assistant activation failed for agent",e,{agentId:i.id}),null}}));return{agentId:i.id,integrationResult:o}}))}dispose(){this._disposables.disposeAsync()}}}}]);