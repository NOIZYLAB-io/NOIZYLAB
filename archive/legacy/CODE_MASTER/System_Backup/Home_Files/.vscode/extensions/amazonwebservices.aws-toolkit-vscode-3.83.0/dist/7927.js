"use strict";exports.id=7927,exports.ids=[7927],exports.modules={37927:(Ie,L,l)=>{l.d(L,{ENV_CMDS_FULL_URI:()=>_,ENV_CMDS_RELATIVE_URI:()=>T,fromContainerMetadata:()=>K,fromInstanceMetadata:()=>ie,getInstanceMetadataEndpoint:()=>y,httpRequest:()=>p});var f=l(73230),x=l(87016),v=l(70732),F=l(20181),k=l(58611);function p(e){return new Promise((t,o)=>{const n=(0,k.request)({method:"GET",...e,hostname:e.hostname?.replace(/^\[(.+)\]$/,"$1")});n.on("error",a=>{o(Object.assign(new v.m("Unable to connect to instance metadata service"),a)),n.destroy()}),n.on("timeout",()=>{o(new v.m("TimeoutError from instance metadata service")),n.destroy()}),n.on("response",a=>{const{statusCode:s=400}=a;(s<200||300<=s)&&(o(Object.assign(new v.m("Error response received from instance metadata service"),{statusCode:s})),n.destroy());const u=[];a.on("data",r=>{u.push(r)}),a.on("end",()=>{t(F.Buffer.concat(u)),n.destroy()})}),n.end()})}const D=e=>Boolean(e)&&typeof e=="object"&&typeof e.AccessKeyId=="string"&&typeof e.SecretAccessKey=="string"&&typeof e.Token=="string"&&typeof e.Expiration=="string",w=e=>({accessKeyId:e.AccessKeyId,secretAccessKey:e.SecretAccessKey,sessionToken:e.Token,expiration:new Date(e.Expiration),...e.AccountId&&{accountId:e.AccountId}}),U=1e3,W=0,O=({maxRetries:e=W,timeout:t=U})=>({maxRetries:e,timeout:t}),h=(e,t)=>{let o=e();for(let n=0;n<t;n++)o=o.catch(e);return o},_="AWS_CONTAINER_CREDENTIALS_FULL_URI",T="AWS_CONTAINER_CREDENTIALS_RELATIVE_URI",M="AWS_CONTAINER_AUTHORIZATION_TOKEN",K=(e={})=>{const{timeout:t,maxRetries:o}=O(e);return()=>h(async()=>{const n=await j({logger:e.logger}),a=JSON.parse(await $(t,n));if(!D(a))throw new f.C("Invalid response received from instance metadata service.",{logger:e.logger});return w(a)},o)},$=async(e,t)=>(process.env[M]&&(t.headers={...t.headers,Authorization:process.env[M]}),(await p({...t,timeout:e})).toString()),B="169.254.170.2",G={localhost:!0,"127.0.0.1":!0},H={"http:":!0,"https:":!0},j=async({logger:e})=>{if(process.env[T])return{hostname:B,path:process.env[T]};if(process.env[_]){const t=(0,x.parse)(process.env[_]);if(!t.hostname||!(t.hostname in G))throw new f.C(`${t.hostname} is not a valid container metadata service hostname`,{tryNextLink:!1,logger:e});if(!t.protocol||!(t.protocol in H))throw new f.C(`${t.protocol} is not a valid container metadata service protocol`,{tryNextLink:!1,logger:e});return{...t,port:t.port?parseInt(t.port,10):void 0}}throw new f.C(`The container metadata credential provider cannot be used unless the ${T} or ${_} environment variable is set`,{tryNextLink:!1,logger:e})};var g=l(8075);class C extends f.C{constructor(t,o=!0){super(t,o),this.tryNextLink=o,this.name="InstanceMetadataV1FallbackError",Object.setPrototypeOf(this,C.prototype)}}var Z=l(92680),S;(function(e){e.IPv4="http://169.254.169.254",e.IPv6="http://[fd00:ec2::254]"})(S||(S={}));const z="AWS_EC2_METADATA_SERVICE_ENDPOINT",J="ec2_metadata_service_endpoint",Y={environmentVariableSelector:e=>e[z],configFileSelector:e=>e[J],default:void 0};var E;(function(e){e.IPv4="IPv4",e.IPv6="IPv6"})(E||(E={}));const X="AWS_EC2_METADATA_SERVICE_ENDPOINT_MODE",q="ec2_metadata_service_endpoint_mode",Q={environmentVariableSelector:e=>e[X],configFileSelector:e=>e[q],default:E.IPv4},y=async()=>(0,Z.D)(await ee()||await te()),ee=async()=>(0,g.Z)(Y)(),te=async()=>{const e=await(0,g.Z)(Q)();switch(e){case E.IPv4:return S.IPv4;case E.IPv6:return S.IPv6;default:throw new Error(`Unsupported endpoint mode: ${e}. Select from ${Object.values(E)}`)}},ne=5*60,ae=5*60,oe="https://docs.aws.amazon.com/sdkref/latest/guide/feature-static-credentials.html",P=(e,t)=>{const o=ne+Math.floor(Math.random()*ae),n=new Date(Date.now()+o*1e3);t.warn(`Attempting credential expiration extension due to a credential service availability issue. A refresh of these credentials will be attempted after ${new Date(n)}.
For more information, please visit: `+oe);const a=e.originalExpiration??e.expiration;return{...e,...a?{originalExpiration:a}:{},expiration:n}},se=(e,t={})=>{const o=t?.logger||console;let n;return async()=>{let a;try{a=await e(),a.expiration&&a.expiration.getTime()<Date.now()&&(a=P(a,o))}catch(s){if(n)o.warn("Credential renew failed: ",s),a=P(n,o);else throw s}return n=a,a}},R="/latest/meta-data/iam/security-credentials/",re="/latest/api/token",N="AWS_EC2_METADATA_V1_DISABLED",b="ec2_metadata_v1_disabled",V="x-aws-ec2-metadata-token",ie=(e={})=>se(ce(e),{logger:e.logger}),ce=(e={})=>{let t=!1;const{logger:o,profile:n}=e,{timeout:a,maxRetries:s}=O(e),u=async(r,I)=>{if(t||I.headers?.[V]==null){let i=!1,c=!1;const ue=await(0,g.Z)({environmentVariableSelector:d=>{const m=d[N];if(c=!!m&&m!=="false",m===void 0)throw new f.C(`${N} not set in env, checking config file next.`,{logger:e.logger});return c},configFileSelector:d=>{const m=d[b];return i=!!m&&m!=="false",i},default:!1},{profile:n})();if(e.ec2MetadataV1Disabled||ue){const d=[];throw e.ec2MetadataV1Disabled&&d.push("credential provider initialization (runtime option ec2MetadataV1Disabled)"),i&&d.push(`config file profile (${b})`),c&&d.push(`process environment variable (${N})`),new C(`AWS EC2 Metadata v1 fallback has been blocked by AWS SDK configuration in the following: [${d.join(", ")}].`)}}const Ee=(await h(async()=>{let i;try{i=await de(I)}catch(c){throw c.statusCode===401&&(t=!1),c}return i},r)).trim();return h(async()=>{let i;try{i=await fe(Ee,I,e)}catch(c){throw c.statusCode===401&&(t=!1),c}return i},r)};return async()=>{const r=await y();if(t)return o?.debug("AWS SDK Instance Metadata","using v1 fallback (no token fetch)"),u(s,{...r,timeout:a});{let I;try{I=(await le({...r,timeout:a})).toString()}catch(A){if(A?.statusCode===400)throw Object.assign(A,{message:"EC2 Metadata token request returned error"});return(A.message==="TimeoutError"||[403,404,405].includes(A.statusCode))&&(t=!0),o?.debug("AWS SDK Instance Metadata","using v1 fallback (initial)"),u(s,{...r,timeout:a})}return u(s,{...r,headers:{[V]:I},timeout:a})}}},le=async e=>p({...e,path:re,method:"PUT",headers:{"x-aws-ec2-metadata-token-ttl-seconds":"21600"}}),de=async e=>(await p({...e,path:R})).toString(),fe=async(e,t,o)=>{const n=JSON.parse((await p({...t,path:R+e})).toString());if(!D(n))throw new f.C("Invalid response received from instance metadata service.",{logger:o.logger});return w(n)}}};
