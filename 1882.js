"use strict";var fe=Object.defineProperty;var ge=(O,a,s)=>a in O?fe(O,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):O[a]=s;var Z=(O,a,s)=>(ge(O,typeof a!="symbol"?a+"":a,s),s);exports.id=1882,exports.ids=[1882,9501],exports.modules={21882:(O,a,s)=>{s.d(a,{fromSSO:()=>ce});var r=s(966653),D=s(347874),w=s(336937),C=s(689465),f=s(504753),u=s(617391);const T=e=>Object.entries(e).filter(([t])=>t.startsWith(f.I.SSO_SESSION+u.Q)).reduce((t,[o,n])=>({...t,[o.substring(o.indexOf(u.Q)+1)]:n}),{});var I=s(908555),N=s(921710);const b=()=>({}),K=async(e={})=>(0,N.TA)(e.configFilepath??(0,C.g)()).then(I.A).then(T).catch(b),_=e=>e&&(typeof e.sso_start_url=="string"||typeof e.sso_account_id=="string"||typeof e.sso_session=="string"||typeof e.sso_region=="string"||typeof e.sso_role_name=="string");var U=s(313421),q=s(778273);class m extends q.m{constructor(o,n=!0){super(o,n);Z(this,"name","TokenProviderError");Object.setPrototypeOf(this,m.prototype)}}var W=s(910704);const ee=5*60*1e3,L="To refresh this SSO session run 'aws sso login' with the corresponding profile.",se=async(e,t={})=>{const{SSOOIDCClient:o}=await s.e(4188).then(s.bind(s,434188)),n=c=>t.clientConfig?.[c]??t.parentClientConfig?.[c];return new o(Object.assign({},t.clientConfig??{},{region:e??t.clientConfig?.region,logger:n("logger"),userAgentAppId:n("userAgentAppId")}))},oe=async(e,t,o={})=>{const{CreateTokenCommand:n}=await s.e(4188).then(s.bind(s,434188));return(await se(t,o)).send(new n({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},j=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new m(`Token is expired. ${L}`,!1)},v=(e,t,o=!1)=>{if(typeof t>"u")throw new m(`Value not present for '${e}' in SSO Token${o?". Cannot refresh":""}. ${L}`,!1)};var te=s(34659),ne=s(179896);const{writeFile:re}=ne.promises,ie=(e,t)=>{const o=(0,te.C)(e),n=JSON.stringify(t,null,2);return re(o,n)},B=new Date(0),ae=(e={})=>async({callerClientConfig:t}={})=>{const o={...e,parentClientConfig:{...t,...e.parentClientConfig}};o.logger?.debug("@aws-sdk/token-providers - fromSso");const n=await(0,w.Y)(o),i=(0,D.Bz)({profile:o.profile??t?.profile}),c=n[i];if(c){if(!c.sso_session)throw new m(`Profile '${i}' is missing required property 'sso_session'.`)}else throw new m(`Profile '${i}' could not be found in shared credentials file.`,!1);const g=c.sso_session,d=(await K(o))[g];if(!d)throw new m(`Sso session '${g}' could not be found in shared credentials file.`,!1);for(const l of["sso_start_url","sso_region"])if(!d[l])throw new m(`Sso session '${g}' is missing required property '${l}'.`,!1);const M=d.sso_start_url,h=d.sso_region;let S;try{S=await(0,W.v)(g)}catch{throw new m(`The SSO session token associated with profile=${i} was not found or is invalid. ${L}`,!1)}v("accessToken",S.accessToken),v("expiresAt",S.expiresAt);const{accessToken:y,expiresAt:E}=S,p={token:y,expiration:new Date(E)};if(p.expiration.getTime()-Date.now()>ee)return p;if(Date.now()-B.getTime()<30*1e3)return j(p),p;v("clientId",S.clientId,!0),v("clientSecret",S.clientSecret,!0),v("refreshToken",S.refreshToken,!0);try{B.setTime(Date.now());const l=await oe(S,h,o);v("accessToken",l.accessToken),v("expiresIn",l.expiresIn);const P=new Date(Date.now()+l.expiresIn*1e3);try{await ie(g,{...S,accessToken:l.accessToken,expiresAt:P.toISOString(),refreshToken:l.refreshToken})}catch{}return{token:l.accessToken,expiration:P}}catch{return j(p),p}},F=!1,H=async({ssoStartUrl:e,ssoSession:t,ssoAccountId:o,ssoRegion:n,ssoRoleName:i,ssoClient:c,clientConfig:g,parentClientConfig:k,profile:d,filepath:M,configFilepath:h,ignoreCache:S,logger:y})=>{let E;const p="To refresh this SSO session run aws sso login with the corresponding profile.";if(t)try{const A=await ae({profile:d,filepath:M,configFilepath:h,ignoreCache:S})();E={accessToken:A.token,expiresAt:new Date(A.expiration).toISOString()}}catch(A){throw new r.C(A.message,{tryNextLink:F,logger:y})}else try{E=await(0,W.v)(e)}catch{throw new r.C(`The SSO session associated with this profile is invalid. ${p}`,{tryNextLink:F,logger:y})}if(new Date(E.expiresAt).getTime()-Date.now()<=0)throw new r.C(`The SSO session associated with this profile has expired. ${p}`,{tryNextLink:F,logger:y});const{accessToken:l}=E,{SSOClient:P,GetRoleCredentialsCommand:x}=await s.e(9708).then(s.bind(s,779708)),R=c||new P(Object.assign({},g??{},{logger:g?.logger??k?.logger,region:g?.region??n,userAgentAppId:g?.userAgentAppId??k?.userAgentAppId}));let G;try{G=await R.send(new x({accountId:o,roleName:i,accessToken:l}))}catch(A){throw new r.C(A,{tryNextLink:F,logger:y})}const{roleCredentials:{accessKeyId:Y,secretAccessKey:z,sessionToken:J,expiration:Q,credentialScope:V,accountId:X}={}}=G;if(!Y||!z||!J||!Q)throw new r.C("SSO returns an invalid temporary credential.",{tryNextLink:F,logger:y});const $={accessKeyId:Y,secretAccessKey:z,sessionToken:J,expiration:new Date(Q),...V&&{credentialScope:V},...X&&{accountId:X}};return t?(0,U.g)($,"CREDENTIALS_SSO","s"):(0,U.g)($,"CREDENTIALS_SSO_LEGACY","u"),$},le=(e,t)=>{const{sso_start_url:o,sso_account_id:n,sso_region:i,sso_role_name:c}=e;if(!o||!n||!i||!c)throw new r.C(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:t});return e},ce=(e={})=>async({callerClientConfig:t}={})=>{e.logger?.debug("@aws-sdk/credential-provider-sso - fromSSO");const{ssoStartUrl:o,ssoAccountId:n,ssoRegion:i,ssoRoleName:c,ssoSession:g}=e,{ssoClient:k}=e,d=(0,D.Bz)({profile:e.profile??t?.profile});if(!o&&!n&&!i&&!c&&!g){const h=(await(0,w.Y)(e))[d];if(!h)throw new r.C(`Profile ${d} was not found.`,{logger:e.logger});if(!_(h))throw new r.C(`Profile ${d} is not configured with SSO credentials.`,{logger:e.logger});if(h?.sso_session){const x=(await K(e))[h.sso_session],R=` configurations in profile ${d} and sso-session ${h.sso_session}`;if(i&&i!==x.sso_region)throw new r.C("Conflicting SSO region"+R,{tryNextLink:!1,logger:e.logger});if(o&&o!==x.sso_start_url)throw new r.C("Conflicting SSO start_url"+R,{tryNextLink:!1,logger:e.logger});h.sso_region=x.sso_region,h.sso_start_url=x.sso_start_url}const{sso_start_url:S,sso_account_id:y,sso_region:E,sso_role_name:p,sso_session:l}=le(h,e.logger);return H({ssoStartUrl:S,ssoSession:l,ssoAccountId:y,ssoRegion:E,ssoRoleName:p,ssoClient:k,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:d,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}else{if(!o||!n||!i||!c)throw new r.C('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger});return H({ssoStartUrl:o,ssoSession:g,ssoAccountId:n,ssoRegion:i,ssoRoleName:c,ssoClient:k,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:d,filepath:e.filepath,configFilepath:e.configFilepath,ignoreCache:e.ignoreCache,logger:e.logger})}}},34659:(O,a,s)=>{s.d(a,{C:()=>u});var r=s(776982),D=s.n(r),w=s(16928),C=s.n(w),f=s(572234);const u=T=>{const N=(0,r.createHash)("sha1").update(T).digest("hex");return(0,w.join)((0,f.R)(),".aws","sso","cache",`${N}.json`)}},910704:(O,a,s)=>{s.d(a,{a:()=>C,v:()=>f});var r=s(191943),D=s.n(r),w=s(34659);const C={},f=async u=>{if(C[u])return C[u];const T=(0,w.C)(u),I=await(0,r.readFile)(T,"utf8");return JSON.parse(I)}},336937:(O,a,s)=>{s.d(a,{Y:()=>w});var r=s(201933);const D=(...C)=>{const f={};for(const u of C)for(const[T,I]of Object.entries(u))f[T]!==void 0?Object.assign(f[T],I):f[T]=I;return f},w=async C=>{const f=await(0,r.p)(C);return D(f.configFile,f.credentialsFile)}}};
