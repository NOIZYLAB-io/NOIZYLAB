"use strict";exports.id=5105,exports.ids=[5105],exports.modules={155105:(fe,W,t)=>{t.d(W,{fromSSO:()=>le});var g=t(673230),N=t(631475),D=t(993628),Y=t(657522),B=t(382308),E=t(410336);const J=e=>Object.entries(e).filter(([o])=>o.startsWith(B.I.SSO_SESSION+E.Q)).reduce((o,[s,n])=>({...o,[s.substring(s.indexOf(E.Q)+1)]:n}),{});var Q=t(544898),V=t(356703);const X=()=>({}),R=async(e={})=>(0,V.$H)(e.configFilepath??(0,Y.g)()).then(Q.A).then(J).catch(X),Z=e=>e&&(typeof e.sso_start_url=="string"||typeof e.sso_account_id=="string"||typeof e.sso_session=="string"||typeof e.sso_region=="string"||typeof e.sso_role_name=="string");var $=t(727650),b=t(470732);class h extends b.m{constructor(o,s=!0){super(o,s),this.name="TokenProviderError",Object.setPrototypeOf(this,h.prototype)}}var A=t(179896),q=t(776982),_=t(16928),ee=t(792747);const F=e=>{const s=(0,q.createHash)("sha1").update(e).digest("hex");return(0,_.join)((0,ee.R)(),".aws","sso","cache",`${s}.json`)},{readFile:se}=A.promises,L={},P=async e=>{if(L[e])return L[e];const o=F(e),s=await se(o,"utf8");return JSON.parse(s)},oe=5*60*1e3,I="To refresh this SSO session run 'aws sso login' with the corresponding profile.",te=async(e,o={})=>{const{SSOOIDCClient:s}=await t.e(7177).then(t.bind(t,837177));return new s(Object.assign({},o.clientConfig??{},{region:e??o.clientConfig?.region,logger:o.clientConfig?.logger??o.parentClientConfig?.logger}))},ne=async(e,o,s={})=>{const{CreateTokenCommand:n}=await t.e(7177).then(t.bind(t,837177));return(await te(o,s)).send(new n({clientId:e.clientId,clientSecret:e.clientSecret,refreshToken:e.refreshToken,grantType:"refresh_token"}))},j=e=>{if(e.expiration&&e.expiration.getTime()<Date.now())throw new h(`Token is expired. ${I}`,!1)},w=(e,o,s=!1)=>{if(typeof o>"u")throw new h(`Value not present for '${e}' in SSO Token${s?". Cannot refresh":""}. ${I}`,!1)},{writeFile:re}=A.promises,ie=(e,o)=>{const s=F(e),n=JSON.stringify(o,null,2);return re(s,n)},H=new Date(0),ae=(e={})=>async({callerClientConfig:o}={})=>{const s={...e,parentClientConfig:{...o,...e.parentClientConfig}};s.logger?.debug("@aws-sdk/token-providers - fromSso");const n=await(0,D.Y)(s),r=(0,N.Bz)({profile:s.profile??o?.profile}),d=n[r];if(d){if(!d.sso_session)throw new h(`Profile '${r}' is missing required property 'sso_session'.`)}else throw new h(`Profile '${r}' could not be found in shared credentials file.`,!1);const f=d.sso_session,l=(await R(s))[f];if(!l)throw new h(`Sso session '${f}' could not be found in shared credentials file.`,!1);for(const a of["sso_start_url","sso_region"])if(!l[a])throw new h(`Sso session '${f}' is missing required property '${a}'.`,!1);const u=l.sso_start_url,i=l.sso_region;let c;try{c=await P(f)}catch{throw new h(`The SSO session token associated with profile=${r} was not found or is invalid. ${I}`,!1)}w("accessToken",c.accessToken),w("expiresAt",c.expiresAt);const{accessToken:x,expiresAt:y}=c,S={token:x,expiration:new Date(y)};if(S.expiration.getTime()-Date.now()>oe)return S;if(Date.now()-H.getTime()<30*1e3)return j(S),S;w("clientId",c.clientId,!0),w("clientSecret",c.clientSecret,!0),w("refreshToken",c.refreshToken,!0);try{H.setTime(Date.now());const a=await ne(c,i,s);w("accessToken",a.accessToken),w("expiresIn",a.expiresIn);const m=new Date(Date.now()+a.expiresIn*1e3);try{await ie(f,{...c,accessToken:a.accessToken,expiresAt:m.toISOString(),refreshToken:a.refreshToken})}catch{}return{token:a.accessToken,expiration:m}}catch{return j(S),S}},T=!1,K=async({ssoStartUrl:e,ssoSession:o,ssoAccountId:s,ssoRegion:n,ssoRoleName:r,ssoClient:d,clientConfig:f,parentClientConfig:O,profile:l,logger:u})=>{let i;const c="To refresh this SSO session run aws sso login with the corresponding profile.";if(o)try{const C=await ae({profile:l})();i={accessToken:C.token,expiresAt:new Date(C.expiration).toISOString()}}catch(C){throw new g.C(C.message,{tryNextLink:T,logger:u})}else try{i=await P(e)}catch{throw new g.C(`The SSO session associated with this profile is invalid. ${c}`,{tryNextLink:T,logger:u})}if(new Date(i.expiresAt).getTime()-Date.now()<=0)throw new g.C(`The SSO session associated with this profile has expired. ${c}`,{tryNextLink:T,logger:u});const{accessToken:x}=i,{SSOClient:y,GetRoleCredentialsCommand:S}=await t.e(9973).then(t.bind(t,769973)),a=d||new y(Object.assign({},f??{},{logger:f?.logger??O?.logger,region:f?.region??n}));let m;try{m=await a.send(new S({accountId:s,roleName:r,accessToken:x}))}catch(C){throw new g.C(C,{tryNextLink:T,logger:u})}const{roleCredentials:{accessKeyId:p,secretAccessKey:k,sessionToken:U,expiration:G,credentialScope:M,accountId:z}={}}=m;if(!p||!k||!U||!G)throw new g.C("SSO returns an invalid temporary credential.",{tryNextLink:T,logger:u});const v={accessKeyId:p,secretAccessKey:k,sessionToken:U,expiration:new Date(G),...M&&{credentialScope:M},...z&&{accountId:z}};return o?(0,$.g)(v,"CREDENTIALS_SSO","s"):(0,$.g)(v,"CREDENTIALS_SSO_LEGACY","u"),v},ce=(e,o)=>{const{sso_start_url:s,sso_account_id:n,sso_region:r,sso_role_name:d}=e;if(!s||!n||!r||!d)throw new g.C(`Profile is configured with invalid SSO credentials. Required parameters "sso_account_id", "sso_region", "sso_role_name", "sso_start_url". Got ${Object.keys(e).join(", ")}
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html`,{tryNextLink:!1,logger:o});return e},le=(e={})=>async({callerClientConfig:o}={})=>{e.logger?.debug("@aws-sdk/credential-provider-sso - fromSSO");const{ssoStartUrl:s,ssoAccountId:n,ssoRegion:r,ssoRoleName:d,ssoSession:f}=e,{ssoClient:O}=e,l=(0,N.Bz)({profile:e.profile??o?.profile});if(!s&&!n&&!r&&!d&&!f){const i=(await(0,D.Y)(e))[l];if(!i)throw new g.C(`Profile ${l} was not found.`,{logger:e.logger});if(!Z(i))throw new g.C(`Profile ${l} is not configured with SSO credentials.`,{logger:e.logger});if(i?.sso_session){const p=(await R(e))[i.sso_session],k=` configurations in profile ${l} and sso-session ${i.sso_session}`;if(r&&r!==p.sso_region)throw new g.C("Conflicting SSO region"+k,{tryNextLink:!1,logger:e.logger});if(s&&s!==p.sso_start_url)throw new g.C("Conflicting SSO start_url"+k,{tryNextLink:!1,logger:e.logger});i.sso_region=p.sso_region,i.sso_start_url=p.sso_start_url}const{sso_start_url:c,sso_account_id:x,sso_region:y,sso_role_name:S,sso_session:a}=ce(i,e.logger);return K({ssoStartUrl:c,ssoSession:a,ssoAccountId:x,ssoRegion:y,ssoRoleName:S,ssoClient:O,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:l})}else{if(!s||!n||!r||!d)throw new g.C('Incomplete configuration. The fromSSO() argument hash must include "ssoStartUrl", "ssoAccountId", "ssoRegion", "ssoRoleName"',{tryNextLink:!1,logger:e.logger});return K({ssoStartUrl:s,ssoSession:f,ssoAccountId:n,ssoRegion:r,ssoRoleName:d,ssoClient:O,clientConfig:e.clientConfig,parentClientConfig:e.parentClientConfig,profile:l})}}}};
