"use strict";var pe=Object.defineProperty;var Ae=(u,i,r)=>i in u?pe(u,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):u[i]=r;var O=(u,i,r)=>(Ae(u,typeof i!="symbol"?i+"":i,r),r);exports.id=4390,exports.ids=[4390],exports.modules={924390:(u,i,r)=>{r.d(i,{ENV_CMDS_FULL_URI:()=>S,ENV_CMDS_RELATIVE_URI:()=>v,fromContainerMetadata:()=>B,fromInstanceMetadata:()=>le,getInstanceMetadataEndpoint:()=>b,httpRequest:()=>_});var E=r(966653),k=r(187016),g=r(778273),U=r(320181),W=r(958611);function _(e){return new Promise((t,o)=>{const n=(0,W.request)({method:"GET",...e,hostname:e.hostname?.replace(/^\[(.+)\]$/,"$1")});n.on("error",a=>{o(Object.assign(new g.m("Unable to connect to instance metadata service"),a)),n.destroy()}),n.on("timeout",()=>{o(new g.m("TimeoutError from instance metadata service")),n.destroy()}),n.on("response",a=>{const{statusCode:s=400}=a;(s<200||300<=s)&&(o(Object.assign(new g.m("Error response received from instance metadata service"),{statusCode:s})),n.destroy());const m=[];a.on("data",c=>{m.push(c)}),a.on("end",()=>{t(U.Buffer.concat(m)),n.destroy()})}),n.end()})}const M=e=>Boolean(e)&&typeof e=="object"&&typeof e.AccessKeyId=="string"&&typeof e.SecretAccessKey=="string"&&typeof e.Token=="string"&&typeof e.Expiration=="string",y=e=>({accessKeyId:e.AccessKeyId,secretAccessKey:e.SecretAccessKey,sessionToken:e.Token,expiration:new Date(e.Expiration),...e.AccountId&&{accountId:e.AccountId}}),K=1e3,$=0,P=({maxRetries:e=$,timeout:t=K})=>({maxRetries:e,timeout:t}),N=(e,t)=>{let o=e();for(let n=0;n<t;n++)o=o.catch(e);return o},S="AWS_CONTAINER_CREDENTIALS_FULL_URI",v="AWS_CONTAINER_CREDENTIALS_RELATIVE_URI",R="AWS_CONTAINER_AUTHORIZATION_TOKEN",B=(e={})=>{const{timeout:t,maxRetries:o}=P(e);return()=>N(async()=>{const n=await z({logger:e.logger}),a=JSON.parse(await G(t,n));if(!M(a))throw new E.C("Invalid response received from instance metadata service.",{logger:e.logger});return y(a)},o)},G=async(e,t)=>(process.env[R]&&(t.headers={...t.headers,Authorization:process.env[R]}),(await _({...t,timeout:e})).toString()),H="169.254.170.2",j={localhost:!0,"127.0.0.1":!0},Z={"http:":!0,"https:":!0},z=async({logger:e})=>{if(process.env[v])return{hostname:H,path:process.env[v]};if(process.env[S]){const t=(0,k.parse)(process.env[S]);if(!t.hostname||!(t.hostname in j))throw new E.C(`${t.hostname} is not a valid container metadata service hostname`,{tryNextLink:!1,logger:e});if(!t.protocol||!(t.protocol in Z))throw new E.C(`${t.protocol} is not a valid container metadata service protocol`,{tryNextLink:!1,logger:e});return{...t,port:t.port?parseInt(t.port,10):void 0}}throw new E.C(`The container metadata credential provider cannot be used unless the ${v} or ${S} environment variable is set`,{tryNextLink:!1,logger:e})};var C=r(848192);class D extends E.C{constructor(o,n=!0){super(o,n);O(this,"tryNextLink");O(this,"name","InstanceMetadataV1FallbackError");this.tryNextLink=n,Object.setPrototypeOf(this,D.prototype)}}var J=r(580890),h;(function(e){e.IPv4="http://169.254.169.254",e.IPv6="http://[fd00:ec2::254]"})(h||(h={}));const Y="AWS_EC2_METADATA_SERVICE_ENDPOINT",X="ec2_metadata_service_endpoint",q={environmentVariableSelector:e=>e[Y],configFileSelector:e=>e[X],default:void 0};var I;(function(e){e.IPv4="IPv4",e.IPv6="IPv6"})(I||(I={}));const Q="AWS_EC2_METADATA_SERVICE_ENDPOINT_MODE",ee="ec2_metadata_service_endpoint_mode",te={environmentVariableSelector:e=>e[Q],configFileSelector:e=>e[ee],default:I.IPv4},b=async()=>(0,J.D)(await ne()||await ae()),ne=async()=>(0,C.Z)(q)(),ae=async()=>{const e=await(0,C.Z)(te)();switch(e){case I.IPv4:return h.IPv4;case I.IPv6:return h.IPv6;default:throw new Error(`Unsupported endpoint mode: ${e}. Select from ${Object.values(I)}`)}},oe=5*60,re=5*60,se="https://docs.aws.amazon.com/sdkref/latest/guide/feature-static-credentials.html",L=(e,t)=>{const o=oe+Math.floor(Math.random()*re),n=new Date(Date.now()+o*1e3);t.warn(`Attempting credential expiration extension due to a credential service availability issue. A refresh of these credentials will be attempted after ${new Date(n)}.
For more information, please visit: `+se);const a=e.originalExpiration??e.expiration;return{...e,...a?{originalExpiration:a}:{},expiration:n}},ie=(e,t={})=>{const o=t?.logger||console;let n;return async()=>{let a;try{a=await e(),a.expiration&&a.expiration.getTime()<Date.now()&&(a=L(a,o))}catch(s){if(n)o.warn("Credential renew failed: ",s),a=L(n,o);else throw s}return n=a,a}},V="/latest/meta-data/iam/security-credentials/",ce="/latest/api/token",w="AWS_EC2_METADATA_V1_DISABLED",x="ec2_metadata_v1_disabled",F="x-aws-ec2-metadata-token",le=(e={})=>ie(de(e),{logger:e.logger}),de=(e={})=>{let t=!1;const{logger:o,profile:n}=e,{timeout:a,maxRetries:s}=P(e),m=async(c,p)=>{if(t||p.headers?.[F]==null){let l=!1,d=!1;const me=await(0,C.Z)({environmentVariableSelector:f=>{const A=f[w];if(d=!!A&&A!=="false",A===void 0)throw new E.C(`${w} not set in env, checking config file next.`,{logger:e.logger});return d},configFileSelector:f=>{const A=f[x];return l=!!A&&A!=="false",l},default:!1},{profile:n})();if(e.ec2MetadataV1Disabled||me){const f=[];throw e.ec2MetadataV1Disabled&&f.push("credential provider initialization (runtime option ec2MetadataV1Disabled)"),l&&f.push(`config file profile (${x})`),d&&f.push(`process environment variable (${w})`),new D(`AWS EC2 Metadata v1 fallback has been blocked by AWS SDK configuration in the following: [${f.join(", ")}].`)}}const Ie=(await N(async()=>{let l;try{l=await Ee(p)}catch(d){throw d.statusCode===401&&(t=!1),d}return l},c)).trim();return N(async()=>{let l;try{l=await ue(Ie,p,e)}catch(d){throw d.statusCode===401&&(t=!1),d}return l},c)};return async()=>{const c=await b();if(t)return o?.debug("AWS SDK Instance Metadata","using v1 fallback (no token fetch)"),m(s,{...c,timeout:a});{let p;try{p=(await fe({...c,timeout:a})).toString()}catch(T){if(T?.statusCode===400)throw Object.assign(T,{message:"EC2 Metadata token request returned error"});return(T.message==="TimeoutError"||[403,404,405].includes(T.statusCode))&&(t=!0),o?.debug("AWS SDK Instance Metadata","using v1 fallback (initial)"),m(s,{...c,timeout:a})}return m(s,{...c,headers:{[F]:p},timeout:a})}}},fe=async e=>_({...e,path:ce,method:"PUT",headers:{"x-aws-ec2-metadata-token-ttl-seconds":"21600"}}),Ee=async e=>(await _({...e,path:V})).toString(),ue=async(e,t,o)=>{const n=JSON.parse((await _({...t,path:V+e})).toString());if(!M(n))throw new E.C("Invalid response received from instance metadata service.",{logger:o.logger});return y(n)}}};
