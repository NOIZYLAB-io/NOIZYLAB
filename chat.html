<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1em; background: #111; color: #eee; }
    #log { height: 70vh; overflow-y: auto; background: #1e1e1e; padding: 1em; border-radius: 8px; }
    textarea { width: 100%; height: 80px; margin-top: 1em; border-radius: 6px; border: none; padding: .5em; background: #222; color: #eee; }
    button { margin-top: .5em; padding: .5em 1em; border: none; border-radius: 6px; background: #00adee; color: #fff; cursor: pointer; }
    select { background: #222; color: #eee; border: none; padding: .3em; border-radius: 4px; }
    .status { font-size: 12px; color: #666; margin-top: 5px; }
    .agent-cmd { color: #ff6b35; font-weight: bold; }
    .system-msg { color: #999; font-style: italic; }
  </style>
</head>
<body>
  <h2>Noizy Chat</h2>
  <div>
    <label>Model: </label>
    <select id="model">
      <option value="openai">OpenAI GPT</option>
      <option value="anthropic">Claude</option>
      <option value="copilot">Copilot</option>
    </select>
    <span class="status" id="status">Connecting...</span>
  </div>
  <div id="log"></div>
  <textarea id="input" placeholder="Ask anything or send agent commands like @agent06 refresh..."></textarea>
  <button id="send">Send</button>

  <script>
    const vscode = acquireVsCodeApi();
    const log = document.getElementById('log');
    const sendBtn = document.getElementById('send');
    const input = document.getElementById('input');
    const modelSel = document.getElementById('model');
    const status = document.getElementById('status');

    let ws = null;
    let reconnectTimer = null;

    function connectWebSocket() {
      try {
        ws = new WebSocket("ws://127.0.0.1:5051");
        
        ws.onopen = () => {
          status.textContent = "Connected to Noizy Stream";
          status.style.color = "#0f0";
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }
        };

        ws.onclose = () => {
          status.textContent = "Disconnected - Retrying...";
          status.style.color = "#f60";
          reconnectTimer = setTimeout(connectWebSocket, 3000);
        };

        ws.onerror = (error) => {
          status.textContent = "Connection error";
          status.style.color = "#f00";
        };

        ws.onmessage = ev => {
          const data = ev.data;
          if (data.includes("<END>")) {
            log.innerHTML += "<hr style='border-color:#333; margin:10px 0;'>";
          } else if (data.startsWith("@")) {
            log.innerHTML += `<div class="agent-cmd">${data}</div>`;
          } else if (!data.startsWith("AI:")) {
            log.innerHTML += `<div class="system-msg"><b>System:</b> ${data}</div>`;
          } else {
            log.innerHTML += `<div style="color:#00adee"><b>AI:</b> ${data}</div>`;
          }
          log.scrollTop = log.scrollHeight;
        };
      } catch (error) {
        status.textContent = "WebSocket not available";
        status.style.color = "#f60";
      }
    }

    sendBtn.onclick = () => {
      const text = input.value.trim();
      if (!text) return;
      
      if (text.startsWith("@")) {
        log.innerHTML += `<div class="agent-cmd"><b>Command:</b> ${text}</div>`;
      } else {
        log.innerHTML += `<div><b>You:</b> ${text}</div>`;
      }
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        if (text.startsWith("@")) {
          ws.send(text);  // Direct agent command
        } else {
          ws.send(JSON.stringify({ model: modelSel.value, prompt: text }));
        }
      } else {
        // Fallback to VS Code extension
        vscode.postMessage({ command: 'ask', text, model: modelSel.value });
      }
      
      input.value = '';
    };

    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.onclick();
      }
    });

    window.addEventListener('message', event => {
      const msg = event.data;
      if (msg.command === 'reply') {
        log.innerHTML += `<div style="color:#00adee;"><b>AI:</b> ${msg.text}</div>`;
        log.scrollTop = log.scrollHeight;
      }
    });

    // Try to connect to WebSocket stream
    connectWebSocket();

    // Load chat history on startup
    fetch('vscode-resource://history')
      .then(() => {
        // Extension will intercept and return chat_history.jsonl contents
        // handled in extension.js
      })
      .catch(() => {
        console.log('No chat history available');
      });
  </script>
</body>
</html>